<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Bidding - Tendersmith</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/bidder.css">
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
  
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="bidder.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="bidder.html">My Auctions</a></li>
        <li><a href="bidderaccount.html">Account</a></li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
  </nav>

  <main class="content container mt-4">
    <h2 id="event-title">Auction</h2>
    
    <!-- Pre-Auction Message (shown when auction hasn't started) -->
    <div id="pre-auction-message" style="display: none; text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
      <h3 style="color: #2563eb; margin-bottom: 16px;">Auction Starts In</h3>
      <div id="time-until-auction" style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 8px;">--:--:--</div>
      <p style="color: #64748b; margin: 0;">Please wait for the auction to begin</p>
    </div>

    <!-- Auction Info (shown when auction is active) -->
    <div id="auction-info">
      <p><strong>Starts:</strong> <span id="auction-start-time">Loading...</span></p>
      <p><strong>Time left:</strong> <span id="auction-countdown">00:00:00</span></p>
      <p><strong>Status:</strong> <span id="auction-status">Loading...</span></p>
    </div>
    <hr />

    <!-- Bidder Line Items -->
    <section id="bidder-lineitems" class="mt-4">
      <h4>Your Line Items</h4>
      <div id="lineitem-overlay" style="position: relative;">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Line Item</th>
              <th>Quantity</th>
              <th>Extended Qty</th>
              <th>Your Bid</th>
              <th>Extended Bid</th>
            </tr>
          </thead>
          <tbody id="lineitem-body">
            <tr><td colspan="6" class="text-center text-muted">Loading your line items...</td></tr>
          </tbody>
        </table>
        <div class="text-end mt-3">
          <button id="submitAllBidsBtn" class="btn btn-primary">Submit All Bids</button>
        </div>
        <!-- Grey overlay for pre-auction state -->
        <div id="grey-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248, 249, 250, 0.9); backdrop-filter: blur(2px); border-radius: 4px; pointer-events: none;"></div>
      </div>
    </section>
  </main>

  <script>
    let eventId;
    let socket;
    let auctionStartTime = null;
    let auctionEndTime = null;
    let countdownInterval = null;
    let preAuctionInterval = null;
    let auctionHasStarted = false;

    // === Pre-Auction Countdown (until auction starts) ===
    function startPreAuctionCountdown(startTime) {
      clearInterval(preAuctionInterval);
      
      function updatePreAuctionDisplay() {
        const now = new Date();
        const diff = startTime - now;
        
        if (diff <= 0) {
          // Auction has started
          clearInterval(preAuctionInterval);
          auctionHasStarted = true;
          showAuctionActive();
          // Start the regular countdown (time left in auction)
          auctionEndTime = new Date(startTime.getTime() + 60 * 60 * 1000);
          startCountdown(auctionEndTime);
          return;
        }
        
        // Calculate time until start
        const hours = Math.floor(diff / 1000 / 60 / 60);
        const minutes = Math.floor((diff / 1000 / 60) % 60);
        const seconds = Math.floor((diff / 1000) % 60);
        document.getElementById("time-until-auction").textContent =
          `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
      }
      
      updatePreAuctionDisplay();
      preAuctionInterval = setInterval(updatePreAuctionDisplay, 1000);
    }

    // === Show pre-auction state ===
    function showPreAuctionState() {
      document.getElementById("pre-auction-message").style.display = "block";
      document.getElementById("auction-info").style.display = "none";
      document.getElementById("grey-overlay").style.display = "block";
    }

    // === Show auction active state ===
    function showAuctionActive() {
      document.getElementById("pre-auction-message").style.display = "none";
      document.getElementById("auction-info").style.display = "block";
      document.getElementById("grey-overlay").style.display = "none";
      
      // Enable all bid inputs
      document.querySelectorAll('.bid-input').forEach(input => {
        input.disabled = false;
      });
    }

    // === Countdown Timer (time left in auction) ===
    function startCountdown(endTime) {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        const now = new Date();
        const diff = endTime - now;
        if (diff <= 0) {
          document.getElementById("auction-countdown").textContent = "00:00:00";
          clearInterval(countdownInterval);
          return;
        }
        const hours = Math.floor(diff / 1000 / 60 / 60);
        const minutes = Math.floor((diff / 1000 / 60) % 60);
        const seconds = Math.floor((diff / 1000) % 60);
        document.getElementById("auction-countdown").textContent =
          `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
      }, 1000);
    }

    // === Load auction info ===
    async function loadAuctionStats() {
      try {
        const res = await authFetch(`/events/${eventId}/stats`);
        const stats = await res.json();
        auctionStartTime = stats.auction_time ? new Date(stats.auction_time) : null;

        // Set the title with Organisation - Category - Event Name
        const orgName = stats.organisation_name || 'Unknown Organisation';
        const catName = stats.category_name || 'No Category';
        const eventName = stats.title || 'Unnamed Event';
        document.getElementById("event-title").textContent = `${orgName} - ${catName} - ${eventName}`;

        document.getElementById("auction-start-time").textContent = auctionStartTime ? auctionStartTime.toLocaleString() : "Not set";
        document.getElementById("auction-status").textContent = stats.type === "paused" ? "Paused" : "Active";

        if (auctionStartTime) {
          const now = new Date();
          
          // Check if auction has already started
          if (now >= auctionStartTime) {
            auctionHasStarted = true;
            showAuctionActive();
            auctionEndTime = new Date(auctionStartTime.getTime() + 60 * 60 * 1000);
            startCountdown(auctionEndTime);
          } else {
            // Auction hasn't started yet
            auctionHasStarted = false;
            showPreAuctionState();
            startPreAuctionCountdown(auctionStartTime);
          }
        }
      } catch (err) {
        console.error("Error loading auction stats:", err);
      }
    }

    // === Load existing bids ===
    async function loadBids() {
      try {
        const res = await authFetch(`/events/${eventId}/bids`);
        const bids = await res.json();
        updateBidDisplay(bids);
      } catch (err) {
        console.error("Error loading bids:", err);
      }
    }

    // === Update leaderboard and stream ===
    function updateBidDisplay(bids) {
      // This function may remain but no leaderboard or stream update since removed from DOM
    }

    // === Load bidder's line items ===
    async function loadBidderLineItems() {
      try {
        const res = await authFetch(`/events/${eventId}/bidder-lineitems`);
        const items = await res.json();
        const tbody = document.getElementById("lineitem-body");

        if (!items || items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No line items assigned.</td></tr>';
          return;
        }

        tbody.innerHTML = items.map(item => `
          <tr data-lineitem="${item.id}">
            <td>${item.rank || "-"}</td>
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.ext_quantity}</td>
            <td>
              <input type="number" class="form-control form-control-sm bid-input" 
                id="bid-${item.id}" min="0" step="0.01" placeholder="Enter bid" 
                value="${item.current_bid || ''}" ${!auctionHasStarted ? 'disabled' : ''}>
            </td>
            <td id="extended-${item.id}">${item.current_bid && item.ext_quantity ? 
                (item.current_bid * item.ext_quantity).toFixed(2) : '-'}</td>
          </tr>
        `).join('');

        // Add event listeners for real-time extended bid calc and submission
        document.querySelectorAll('.bid-input').forEach(input => {
          input.addEventListener('input', e => {
            if (!auctionHasStarted) return;
            const id = e.target.id.split('-')[1];
            const row = items.find(i => i.id == id);
            const val = parseFloat(e.target.value);
            const extendedCell = document.getElementById(`extended-${id}`);
            extendedCell.textContent = !isNaN(val) ? (val * row.ext_quantity).toFixed(2) : '-';
          });

          input.addEventListener('change', async e => {
            if (!auctionHasStarted) return;
            const id = e.target.id.split('-')[1];
            const val = parseFloat(e.target.value);
            if (!val || isNaN(val)) return;
            try {
              const res = await authFetch(`/events/${eventId}/bids`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: val, line_item_id: id })
              });
              if (!res.ok) console.error("Failed to submit bid:", res.statusText);
            } catch (err) {
              console.error("Error submitting bid:", err);
            }
          });
        });
      } catch (err) {
        console.error("Error loading bidder line items:", err);
      }
    }


    // === Submit all bids at once ===
    document.addEventListener("click", async (e) => {
      if (e.target && e.target.id === "submitAllBidsBtn") {
        if (!auctionHasStarted) {
          alert("The auction has not started yet. Please wait for the auction to begin.");
          return;
        }
        
        const inputs = document.querySelectorAll(".bid-input");
        const bidPayload = [];
        inputs.forEach(input => {
          const lineItemId = input.id.split("-")[1];
          const val = parseFloat(input.value);
          if (!isNaN(val) && val > 0) {
            bidPayload.push({ line_item_id: lineItemId, amount: val });
          }
        });
        if (bidPayload.length === 0) {
          alert("Please enter at least one valid bid before submitting.");
          return;
        }

        try {
          const res = await authFetch(`/events/${eventId}/bids/bulk`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bids: bidPayload })
          });
          if (res.ok) {
            alert("Bids submitted successfully!");
          } else {
            alert("Failed to submit bids.");
          }
        } catch (err) {
          console.error("Error submitting multiple bids:", err);
        }
      }
    });

    // === Connect socket ===
    function connectSocket() {
      const token = localStorage.getItem("token");
      const auctionSocket = io(window.location.origin, {
        transports: ["websocket"],
        auth: { token }
      });
      auctionSocket.emit("join_event", eventId);

      auctionSocket.on("bid_update", (bid) => {
        const currentUser = JSON.parse(localStorage.getItem("user"));
        const input = document.getElementById(`bid-${bid.line_item_id}`);
        const extendedCell = document.getElementById(`extended-${bid.line_item_id}`);

        if (input && extendedCell) {
          // If this bidder made the bid, update their bid instantly
          if (currentUser && bid.user_id === currentUser.id) {
            input.value = bid.amount;
            const row = input.closest("tr");
            const extQty = parseFloat(row.children[3].textContent);
            extendedCell.textContent = !isNaN(extQty) ? (bid.amount * extQty).toFixed(2) : "-";
          }
          // Update the rank for that line item
          refreshLineItemRank(bid.line_item_id);
        }
      });

      auctionSocket.on("auction_paused", () => {
        document.getElementById("auction-status").textContent = "Paused";
        alert("Auction paused by manager.");
      });

      auctionSocket.on("auction_resumed", () => {
        document.getElementById("auction-status").textContent = "Active";
        alert("Auction resumed.");
      });
    }

    // === Refresh rank for a line item dynamically (using fast endpoint) ===
    async function refreshLineItemRank(lineItemId) {
      try {
        const res = await authFetch(`/events/${eventId}/line-items/${lineItemId}/rank`);
        const data = await res.json();
        if (data && data.rank !== null) {
          const row = document.querySelector(`tr[data-lineitem="${lineItemId}"]`);
          if (row) row.cells[0].textContent = data.rank;
        }
      } catch (err) {
        console.error("Error updating rank:", err);
      }
    }

    // === Init ===
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      eventId = params.get("id");
      if (!eventId) {
        alert("No event selected.");
        window.location.href = "bidder.html";
        return;
      }

      await loadAuctionStats();
      await loadBids();
      await loadBidderLineItems();
      connectSocket();

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("token");
          window.location.href = "/start.html";
        });
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>