<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Bidding - Tendersmith</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/bidder.css">
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
  
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="bidder.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="bidder.html">My Auctions</a></li>
        <li><a href="bidderaccount.html">Account</a></li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
  </nav>

  <main class="content container mt-4">
    <h2 id="event-title">Auction</h2>
    
    <!-- Pre-Auction Message (shown when auction hasn't started) -->
    <div id="pre-auction-message" style="display: none; text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
      <h3 style="color: #2563eb; margin-bottom: 16px;">Auction Starts In</h3>
      <div id="time-until-auction" style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 8px;">--:--:--</div>
      <p style="color: #64748b; margin: 0;">Please wait for the auction to begin</p>
    </div>

    <!-- Auction Info (shown when auction is active) -->
    <div id="auction-info" style="display: flex; margin-bottom: 24px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; background: #fff;">
      <div style="flex: 1; padding: 12px 16px; border-right: 1px solid #e2e8f0;">
        <span style="font-weight: 600; color: #64748b;">Start Date:</span> <span id="auction-start-date" style="color: #1e293b;">Loading...</span>
      </div>
      <div style="flex: 1; padding: 12px 16px; border-right: 1px solid #e2e8f0;">
        <span style="font-weight: 600; color: #64748b;">Start Time:</span> <span id="auction-start-time" style="color: #1e293b;">Loading...</span>
      </div>
      <div style="flex: 1; padding: 12px 16px; border-right: 1px solid #e2e8f0;">
        <span style="font-weight: 600; color: #64748b;">Time Left:</span> <span id="auction-countdown" style="color: #1e293b;">00:00:00</span>
      </div>
      <div style="flex: 1; padding: 12px 16px; border-right: 1px solid #e2e8f0;">
        <span style="font-weight: 600; color: #64748b;">Currency:</span> <span id="auction-currency" style="color: #1e293b;">Loading...</span>
      </div>
      <div style="flex: 1; padding: 12px 16px;">
        <span style="font-weight: 600; color: #64748b;">Status:</span> <span id="auction-status" style="font-weight: 700;">Loading...</span>
      </div>
    </div>
    <style>
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      #auction-status.status-pulse {
        animation: pulse 2s ease-in-out infinite;
      }
    </style>

    <!-- Bidder Line Items -->
    <section id="bidder-lineitems" class="mt-4">
      <h4>Your Line Items</h4>
      <div id="lineitem-overlay" style="position: relative;">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Line Item</th>
              <th>Quantity</th>
              <th>Extended Qty</th>
              <th>New Bid (Enter Bid)</th>
              <th>New Extended Bid</th>
              <th>Current Bid</th>
              <th>Current Extended Bid</th>
            </tr>
          </thead>
          <tbody id="lineitem-body">
            <tr><td colspan="8" class="text-center text-muted">Loading your line items...</td></tr>
          </tbody>
        </table>
        <div class="text-end mt-3">
          <button id="submitAllBidsBtn" class="btn btn-primary">Submit All Bids</button>
          <div id="pause-warning" style="display: none; color: #dc3545; margin-top: 8px; font-weight: 500;">
            ⚠️ Auction is paused by a manager. Please wait for auction to resume to submit your bid.
          </div>
        </div>
        <!-- Grey overlay for pre-auction state -->
        <div id="grey-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248, 249, 250, 0.9); backdrop-filter: blur(2px); border-radius: 4px; pointer-events: none;"></div>
      </div>
    </section>
  </main>

  <script>
    let eventId;
    let socket;
    let auctionStartTime = null;
    let auctionEndTime = null;
    let countdownInterval = null;
    let preAuctionInterval = null;
    let auctionHasStarted = false;
    let previousBids = {}; // Track previous bid values by line_item_id
    let isPaused = false; // Track if auction is paused
    let currencySymbol = '£'; // Default currency symbol
    const currencySymbols = { GBP:'£', USD:'$', EUR:'€', CAD:'$', AUD:'$', NZD:'$', CHF:'CHF', JPY:'¥', CNY:'¥', INR:'₹', SEK:'kr', NOK:'kr', DKK:'kr', PLN:'zł', ZAR:'R' };

    // Format money with currency symbol
    function fmtMoney(n, symbol){
      try { return `${symbol}${Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; } catch { return `${symbol}${n}`; }
    }

    // === Show pre-auction state ===
    function showPreAuctionState() {
      document.getElementById("pre-auction-message").style.display = "block";
      document.getElementById("auction-info").style.display = "none";
      document.getElementById("grey-overlay").style.display = "block";
    }

    // === Show auction active state ===
    function showAuctionActive() {
      document.getElementById("pre-auction-message").style.display = "none";
      document.getElementById("auction-info").style.display = "flex";
      document.getElementById("grey-overlay").style.display = "none";
      
      // Enable all bid inputs
      document.querySelectorAll('.bid-input').forEach(input => {
        input.disabled = false;
      });
    }

    // === Update submit button state based on pause status ===
    function updateSubmitButtonState() {
      const submitBtn = document.getElementById("submitAllBidsBtn");
      const pauseWarning = document.getElementById("pause-warning");
      
      if (isPaused) {
        submitBtn.disabled = true;
        submitBtn.classList.add("disabled");
        pauseWarning.style.display = "block";
      } else {
        submitBtn.disabled = false;
        submitBtn.classList.remove("disabled");
        pauseWarning.style.display = "none";
      }
    }

    // === Update countdown from server time sync (AUTHORITATIVE) ===
    function updateCountdownFromServer(secondsRemaining, serverPaused) {
      if (secondsRemaining === null || secondsRemaining === undefined) {
        document.getElementById("auction-countdown").textContent = "Not set";
        return;
      }

      // If paused, show paused state
      if (serverPaused || isPaused) {
        const hours = Math.floor(secondsRemaining / 3600);
        const minutes = Math.floor((secondsRemaining % 3600) / 60);
        const seconds = secondsRemaining % 60;
        document.getElementById("auction-countdown").textContent =
          `⏸️ ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        return;
      }

      const hours = Math.floor(secondsRemaining / 3600);
      const minutes = Math.floor((secondsRemaining % 3600) / 60);
      const seconds = secondsRemaining % 60;
      document.getElementById("auction-countdown").textContent =
        `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }

    // === Load auction info ===
    async function loadAuctionStats() {
      try {
        const res = await authFetch(`/events/${eventId}/stats`);
        const stats = await res.json();
        auctionStartTime = stats.auction_time ? new Date(stats.auction_time) : null;
        auctionEndTime = stats.auction_end_time ? new Date(stats.auction_end_time) : null;
        isPaused = stats.type === "paused";

        // Set the title with Organisation - Category - Event Name
        const orgName = stats.organisation_name || 'Unknown Organisation';
        const catName = stats.category_name || 'No Category';
        const eventName = stats.title || 'Unnamed Event';
        document.getElementById("event-title").textContent = `${orgName} - ${catName} - ${eventName}`;

        const currencyCode = (stats.currency || 'GBP').toUpperCase();
        currencySymbol = currencySymbols[currencyCode] || currencyCode || '£';
        document.getElementById("auction-currency").textContent = stats.currency || "Not set";

        if (auctionStartTime) {
          document.getElementById("auction-start-date").textContent = auctionStartTime.toLocaleDateString();
          document.getElementById("auction-start-time").textContent = auctionStartTime.toLocaleTimeString();
        } else {
          document.getElementById("auction-start-date").textContent = "Not set";
          document.getElementById("auction-start-time").textContent = "Not set";
        }

        const statusEl = document.getElementById("auction-status");
        if (isPaused) {
          statusEl.textContent = "Paused";
          statusEl.style.color = "#dc2626"; // Red for paused
          statusEl.classList.add("status-pulse");
        } else {
          statusEl.textContent = "Active";
          statusEl.style.color = "#059669"; // Green for active
          statusEl.classList.add("status-pulse");
        }

        // Update submit button and warning based on pause state
        updateSubmitButtonState();

        if (auctionStartTime) {
          // Check if auction has already started (server will send time_sync events)
          // Note: All timing now handled by server time_sync events
          auctionHasStarted = true;
          showAuctionActive();
        }
      } catch (err) {
        console.error("Error loading auction stats:", err);
      }
    }

    // === Load existing bids ===
    async function loadBids() {
      try {
        const res = await authFetch(`/events/${eventId}/bids`);
        const bids = await res.json();
        updateBidDisplay(bids);
      } catch (err) {
        console.error("Error loading bids:", err);
      }
    }

    // === Update leaderboard and stream ===
    function updateBidDisplay(bids) {
      // This function may remain but no leaderboard or stream update since removed from DOM
    }

    // === Load bidder's line items ===
    async function loadBidderLineItems() {
      try {
        const res = await authFetch(`/events/${eventId}/bidder-lineitems`);
        const items = await res.json();
        const tbody = document.getElementById("lineitem-body");

        if (!items || items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No line items assigned.</td></tr>';
          return;
        }

        tbody.innerHTML = items.map(item => {
          // Store the current bid as the previous bid for comparison
          if (item.current_bid) {
            previousBids[item.id] = item.current_bid;
          }

          return `
          <tr data-lineitem="${item.id}">
            <td>${item.rank || "-"}</td>
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.ext_quantity}</td>
            <td>
              <input type="number" class="form-control form-control-sm bid-input"
                id="bid-${item.id}" min="0" step="0.01" placeholder="Enter bid"
                value="${item.current_bid || ''}"
                ${!auctionHasStarted ? 'disabled' : ''}>
            </td>
            <td id="extended-${item.id}">${item.current_bid && item.ext_quantity ?
                fmtMoney(item.current_bid * item.ext_quantity, currencySymbol) : '-'}</td>
            <td>${item.current_bid ? fmtMoney(item.current_bid, currencySymbol) : '-'}</td>
            <td>${item.current_bid && item.ext_quantity ?
                fmtMoney(item.current_bid * item.ext_quantity, currencySymbol) : '-'}</td>
          </tr>
        `;
        }).join('');

        // Add event listeners for real-time extended bid calc
        document.querySelectorAll('.bid-input').forEach(input => {
          input.addEventListener('input', e => {
            if (!auctionHasStarted) return;
            const id = e.target.id.split('-')[1];
            const row = items.find(i => i.id == id);
            const val = parseFloat(e.target.value);
            const extendedCell = document.getElementById(`extended-${id}`);
            extendedCell.textContent = !isNaN(val) ? fmtMoney(val * row.ext_quantity, currencySymbol) : '-';
          });
        });
      } catch (err) {
        console.error("Error loading bidder line items:", err);
      }
    }


    // === Submit all bids at once ===
    document.addEventListener("click", async (e) => {
      if (e.target && e.target.id === "submitAllBidsBtn") {
        if (!auctionHasStarted) {
          alert("The auction has not started yet. Please wait for the auction to begin.");
          return;
        }
        
        if (isPaused) {
          alert("The auction is currently paused. Please wait for the auction to resume.");
          return;
        }
        
        const inputs = document.querySelectorAll(".bid-input");
        const bidPayload = [];
        inputs.forEach(input => {
          const lineItemId = input.id.split("-")[1];
          const val = parseFloat(input.value);
          
          // Only include bids that are valid AND have changed from previous value
          if (!isNaN(val) && val > 0) {
            const previousBid = previousBids[lineItemId];
            // Include if: no previous bid exists, or the bid has changed
            if (previousBid === undefined || previousBid !== val) {
              bidPayload.push({ line_item_id: lineItemId, amount: val });
            }
          }
        });
        
        if (bidPayload.length === 0) {
          alert("No new or changed bids to submit.");
          return;
        }

        try {
          const res = await authFetch(`/events/${eventId}/bids/bulk`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bids: bidPayload })
          });
          if (res.ok) {
            // Update previousBids with the newly submitted values
            bidPayload.forEach(bid => {
              previousBids[bid.line_item_id] = bid.amount;

              // Update the "Current Bid" column
              const row = document.querySelector(`tr[data-lineitem="${bid.line_item_id}"]`);
              if (row) {
                row.cells[6].textContent = fmtMoney(bid.amount, currencySymbol);

                // Update "Current Extended Bid" column
                const extQtyCell = row.cells[3];
                const extQty = parseFloat(extQtyCell.textContent);
                if (!isNaN(extQty)) {
                  row.cells[7].textContent = fmtMoney(bid.amount * extQty, currencySymbol);
                }

                // Clear the "New Bid" input
                const input = document.getElementById(`bid-${bid.line_item_id}`);
                if (input) {
                  input.value = '';
                }

                // Clear the "New Extended Bid" display
                const extendedCell = document.getElementById(`extended-${bid.line_item_id}`);
                if (extendedCell) {
                  extendedCell.textContent = '-';
                }
              }
            });
            alert(`${bidPayload.length} bid(s) submitted successfully!`);
          } else {
            alert("Failed to submit bids.");
          }
        } catch (err) {
          console.error("Error submitting multiple bids:", err);
        }
      }
    });

    // === Connect socket ===
    function connectSocket() {
      const token = localStorage.getItem("token");
      const auctionSocket = io(window.location.origin, {
        transports: ["websocket"],
        auth: { token }
      });
      auctionSocket.emit("join_event", eventId);

      // SERVER AUTHORITATIVE TIME - Critical for consistency
      auctionSocket.on("time_sync", (data) => {
        const { secondsRemaining, isPaused: serverPaused, endTime } = data;
        
        // Update pause state from server
        if (serverPaused !== isPaused) {
          isPaused = serverPaused;
          updateSubmitButtonState();
          const statusEl = document.getElementById("auction-status");
          if (isPaused) {
            statusEl.textContent = "Paused";
            statusEl.style.color = "#dc2626"; // Red for paused
            statusEl.classList.add("status-pulse");
          } else {
            statusEl.textContent = "Active";
            statusEl.style.color = "#059669"; // Green for active
            statusEl.classList.add("status-pulse");
          }
        }
        
        // Update countdown display with server's authoritative time (pass pause state)
        updateCountdownFromServer(secondsRemaining, serverPaused);
        
        // Update endTime if provided
        if (endTime) {
          auctionEndTime = new Date(endTime);
        }
      });

      auctionSocket.on("bid_update", (bid) => {
        // Only update rank, don't touch the Current Bid columns
        refreshLineItemRank(bid.line_item_id);
      });

      // Note: State is updated by time_sync, these just provide notifications
      auctionSocket.on("auction_paused", () => {
        alert("Auction paused by manager.");
      });

      auctionSocket.on("auction_resumed", () => {
        alert("Auction resumed.");
      });

      auctionSocket.on("auction_extended", (data) => {
        // time_sync will update the countdown
        if (data.newEndTime) {
          alert(`Auction extended by ${data.extensionTime} seconds!`);
        }
      });

      auctionSocket.on("auction_reset", () => {
        console.log("Auction reset! Reloading page...");
        window.location.reload();
      });
    }

    // === Refresh rank for a line item dynamically (using fast endpoint) ===
    async function refreshLineItemRank(lineItemId) {
      try {
        const res = await authFetch(`/events/${eventId}/line-items/${lineItemId}/rank`);
        const data = await res.json();
        if (data && data.rank !== null) {
          const row = document.querySelector(`tr[data-lineitem="${lineItemId}"]`);
          if (row) row.cells[0].textContent = data.rank;
        }
      } catch (err) {
        console.error("Error updating rank:", err);
      }
    }

    // === Init ===
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      eventId = params.get("id");
      if (!eventId) {
        alert("No event selected.");
        window.location.href = "bidder.html";
        return;
      }

      await loadAuctionStats();
      await loadBids();
      await loadBidderLineItems();
      connectSocket();

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("token");
          window.location.href = "/start.html";
        });
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>