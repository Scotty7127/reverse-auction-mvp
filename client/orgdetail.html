<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organisation Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/orgdetail.css">
  <script>
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">üí¨</button></li>
      </ul>
    </div>
  </nav>

  <main class="org-detail-page">
    <button type="button" onclick="goBack()" class="btn-back">‚Üê Back to Organisations</button>

    <div class="page-header-detail">
      <h2 id="page-title">Add Organisation</h2>
    </div>

    <!-- Organisation Details Form -->
    <div class="section-card">
      <div class="section-header">
        <h3>Organisation Details</h3>
        <p>Configure the basic information for this organisation</p>
      </div>
      <div class="section-body">
        <form id="org-form" enctype="multipart/form-data">
          <div class="form-grid">
            <div>
              <label for="org-name" class="form-label">Organisation Name</label>
              <input type="text" id="org-name" name="name" class="form-input" placeholder="Enter organisation name" required>
            </div>
            <div>
              <label for="org-currency" class="form-label">Currency</label>
              <select id="org-currency" name="currency" class="form-select" required>
                <option value="">Select currency</option>
                <option value="USD">USD - US Dollar</option>
                <option value="GBP">GBP - British Pound</option>
                <option value="EUR">EUR - Euro</option>
                <option value="AUD">AUD - Australian Dollar</option>
                <option value="CAD">CAD - Canadian Dollar</option>
              </select>
            </div>
            <div>
              <label for="org-type" class="form-label">Organisation Type</label>
              <select id="org-type" name="type" class="form-select" required>
                <option value="client">Client (Buyer)</option>
                <option value="agency">Agency (Auction Manager)</option>
                <option value="supplier">Supplier (Bidder)</option>
              </select>
            </div>
            <div>
              <label for="org-logo" class="form-label">Logo (Optional)</label>
              <input type="file" id="org-logo" name="logo" class="form-input" accept="image/*">
            </div>
          </div>
          <button type="submit" class="btn-primary-custom">Save Organisation</button>
        </form>
      </div>
    </div>
    <!-- Categories Section (Client Only) -->
    <div id="categories-section" style="display:none;">
      <div class="section-card">
        <div class="section-header">
          <h3>Categories</h3>
          <p>Manage product categories for this client organisation</p>
        </div>
        <div class="section-body">
          <form id="category-form" class="category-form">
            <div>
              <label for="category-name" class="form-label">Category Name</label>
              <input type="text" id="category-name" name="name" class="form-input" placeholder="e.g., Electronics" required>
            </div>
            <div>
              <label for="category-description" class="form-label">Description</label>
              <input type="text" id="category-description" name="description" class="form-input" placeholder="e.g., Electronic components and devices" required>
            </div>
            <div>
              <label class="form-label category-form-label-hidden">Action</label>
              <button type="submit" class="btn-primary-custom">Add Category</button>
            </div>
          </form>
          <div class="table-container">
            <table id="categories-table" class="members-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Categories will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Members Section (All Organisation Types) -->
    <div class="section-card" id="users-section" style="display:none;">
      <div class="section-header">
        <h3>Members</h3>
        <p>Manage team members and their access to this organisation</p>
      </div>
      <div class="section-body">
        <div class="button-group">
          <button class="btn-primary-custom" id="invite-user-btn">Invite New User</button>
          <button class="btn-secondary-custom" id="add-existing-user-btn">Add Existing User</button>
        </div>
        <div class="table-container">
          <table id="users-table" class="members-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th style="text-align: right;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Users populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  
  <script>
    // Uses global apiBase defined in config.js
    const params = new URLSearchParams(window.location.search);
    const orgId = params.get("id");

    const form = document.getElementById("org-form");
    const title = document.getElementById("page-title");


    // Ensure authenticated via API and store current user
    async function ensureAuth() {
      try {
        const res = await authFetch("/users/me");
        if (!res.ok) throw new Error("unauthorized");
        const me = await res.json();
        window.currentUser = me;
        return true;
      } catch (e) {
        // Redirect to sign-in if token is missing/invalid/expired
        window.location.href = "/start.html";
        return false;
      }
    }

    // Load existing organisation if editing
    async function loadOrganisation() {
      if (!orgId) return;
      title.textContent = "Edit Organisation";

      const res = await authFetch(`/organisations/${orgId}`);
      const org = await res.json();

      document.getElementById("org-name").value = org.name || "";
      document.getElementById("org-currency").value = org.currency || "";
      document.getElementById("org-type").value = org.type || "client";

      // Show/hide sections based on org type
      if (org.type === 'client') {
        document.getElementById('categories-section').style.display = 'block';
        fetchCategories();
      } else {
        document.getElementById('categories-section').style.display = 'none';
      }

      // Always show users section for all organization types
      document.getElementById('users-section').style.display = 'block';
      fetchUsers();
    }

    // Handle create or update
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      let method = orgId ? "PUT" : "POST";
      let endpoint = orgId ? `/organisations/${orgId}` : "/organisations";

      const res = await authFetch(endpoint, { method, body: formData });
      if (res.ok) {
        alert("‚úÖ Organisation saved successfully!");
        const data = orgId ? { id: orgId } : await res.json();
        const orgType = document.getElementById("org-type").value;
        
        // If creating a new org, stay on the page to allow adding categories/users
        if (!orgId) {
          window.location.href = `orgdetail.html?id=${data.id}`;
        }
        // If editing, just reload to show updated data
        else {
          await loadOrganisation();
        }
      } else {
        alert("‚ùå Failed to save organisation.");
      }
    });

    function goBack() {
      window.location.href = "organisations.html";
    }

    // Initialize page after successful auth
    (async function init() {
      const ok = await ensureAuth();
      if (!ok) return;
      await loadOrganisation();
      // fetchCategories() or fetchUsers() now handled within loadOrganisation()
    })();
    // Users management (for suppliers)
    async function fetchUsers() {
      if (!orgId) return;
      const res = await authFetch(`/organisations/${orgId}/users`);
      if (res.ok) {
        const users = await res.json();
        renderUsers(users);
      } else {
        console.error('Failed to load users');
      }
    }

    function renderUsers(users) {
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '';
      if (!users.length) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="4">No members yet. Add your first team member above.</td></tr>';
        return;
      }
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight: 500;">${u.first_name || ''} ${u.last_name || ''}</td>
          <td style="color: var(--text-muted);">${u.email}</td>
          <td><span class="role-badge ${u.role}">${u.role}</span></td>
          <td>
            <button class="btn-remove" onclick="removeUser(${u.id})">Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function removeUser(userId) {
      if (!confirm('Are you sure you want to remove this user from the organization?')) return;
      try {
        const res = await authFetch(`/organisations/${orgId}/members/${userId}`, {
          method: 'DELETE'
        });
        if (res.ok) {
          alert('‚úÖ User removed successfully!');
          fetchUsers();
        } else {
          alert('‚ùå Failed to remove user.');
        }
      } catch (err) {
        alert(`‚ùå Error: ${err.message}`);
      }
    }

    const inviteBtn = document.getElementById('invite-user-btn');
    if (inviteBtn) {
      inviteBtn.addEventListener('click', () => {
        const modalEl = document.getElementById('inviteUserModal');
        if (!modalEl || !window.bootstrap) return;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      });
    }

    const inviteForm = document.getElementById('invite-user-form');
    if (inviteForm) {
      inviteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('invite-email')?.value.trim();
        const role = document.getElementById('invite-role')?.value || 'bidder';
        if (!email) return alert('Enter an email address.');
        const res = await authFetch('/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role, organisation_id: orgId })
        });
        if (res.ok) {
          alert('‚úÖ Invitation sent!');
          const modalEl = document.getElementById('inviteUserModal');
          if (modalEl && window.bootstrap) {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }
          inviteForm.reset();
          fetchUsers();
        } else {
          const errorData = await res.json();
          alert(`‚ùå ${errorData.error || 'Failed to send invite.'}`);
        }
      });
    }

    // Add Existing User functionality
    const addExistingUserBtn = document.getElementById('add-existing-user-btn');
    if (addExistingUserBtn) {
      addExistingUserBtn.addEventListener('click', async () => {
        // Fetch available users
        const res = await authFetch(`/users?excludeOrgId=${orgId}`);
        if (res.ok) {
          const users = await res.json();
          showAddExistingUserModal(users);
        } else {
          alert('‚ùå Failed to load available users.');
        }
      });
    }

    function showAddExistingUserModal(users) {
      const modalEl = document.getElementById('addExistingUserModal');
      if (!modalEl || !window.bootstrap) return;

      const select = document.getElementById('existing-user-select');
      select.innerHTML = '<option value="">Select a user...</option>';

      users.forEach(u => {
        const option = document.createElement('option');
        option.value = u.id;
        option.textContent = `${u.first_name || ''} ${u.last_name || ''} (${u.email})${u.organisation_name ? ' - ' + u.organisation_name : ''}`;
        select.appendChild(option);
      });

      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    const addExistingUserForm = document.getElementById('add-existing-user-form');
    if (addExistingUserForm) {
      addExistingUserForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('existing-user-select')?.value;
        if (!userId) return alert('Please select a user.');

        const res = await authFetch(`/organisations/${orgId}/members/${userId}`, {
          method: 'PATCH'
        });

        if (res.ok) {
          alert('‚úÖ User added successfully!');
          const modalEl = document.getElementById('addExistingUserModal');
          if (modalEl && window.bootstrap) {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }
          addExistingUserForm.reset();
          fetchUsers();
        } else {
          const errorData = await res.json();
          alert(`‚ùå ${errorData.error || 'Failed to add user.'}`);
        }
      });
    }

    // Categories management
    const categoryForm = document.getElementById("category-form");
    const categoryNameInput = document.getElementById("category-name");
    const categoryDescriptionInput = document.getElementById("category-description");
    const categoriesTableBody = document.querySelector("#categories-table tbody");

    let editingCategoryId = null;

    async function fetchCategories() {
      if (!orgId) {
        categoriesTableBody.innerHTML = '<tr><td colspan="3">Save organisation first to manage categories.</td></tr>';
        return;
      }
      try {
        const res = await authFetch(`/organisations/${orgId}/categories`);
        if (res.ok) {
          const categories = await res.json();
          renderCategories(categories);
        } else {
          let errorMsg = "Failed to load categories.";
          try {
            const errData = await res.json();
            if (errData && errData.error) errorMsg += ` (${errData.error})`;
          } catch {}
          categoriesTableBody.innerHTML = `<tr><td colspan="3">${errorMsg}</td></tr>`;
        }
      } catch (err) {
        categoriesTableBody.innerHTML = `<tr><td colspan="3">Error loading categories: ${err.message}</td></tr>`;
        console.error("Error fetching categories:", err);
      }
    }

    function renderCategories(categories) {
      if (!categories.length) {
        categoriesTableBody.innerHTML = '<tr class="empty-row"><td colspan="3">No categories yet. Add your first category above.</td></tr>';
        return;
      }
      categoriesTableBody.innerHTML = "";
      categories.forEach(cat => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = cat.name;
        nameTd.style.fontWeight = "500";
        tr.appendChild(nameTd);

        const descTd = document.createElement("td");
        descTd.textContent = cat.description;
        descTd.style.color = "var(--text-muted)";
        tr.appendChild(descTd);

        const actionsTd = document.createElement("td");
        actionsTd.style.textAlign = "right";
        actionsTd.style.whiteSpace = "nowrap";

        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "btn-secondary-custom category-edit-btn";
        editBtn.addEventListener("click", () => startEditCategory(cat));
        actionsTd.appendChild(editBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "btn-remove";
        deleteBtn.addEventListener("click", () => deleteCategory(cat.id));
        actionsTd.appendChild(deleteBtn);

        tr.appendChild(actionsTd);

        categoriesTableBody.appendChild(tr);
      });
    }

    function startEditCategory(category) {
      editingCategoryId = category.id;
      categoryNameInput.value = category.name;
      categoryDescriptionInput.value = category.description;
      const submitBtn = categoryForm.querySelector("button[type='submit']");
      submitBtn.textContent = "Save Changes";
      submitBtn.style.background = "#059669";
    }

    categoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!orgId) {
        alert("Please save the organisation first before managing categories.");
        return;
      }

      const name = categoryNameInput.value.trim();
      const description = categoryDescriptionInput.value.trim();

      if (!name || !description) {
        alert("Please provide both name and description for the category.");
        return;
      }

      let res;
      try {
        // For debugging: show orgId before submit
        console.log("[Category Submit] orgId:", orgId);
        let requestUrl, requestOptions;
        if (editingCategoryId) {
          // Update existing category
          requestUrl = `/categories/${editingCategoryId}`;
          requestOptions = {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, description })
          };
        } else {
          // Create new category
          requestUrl = `/organisations/${orgId}/categories`;
          requestOptions = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, description })
          };
        }
        // Log request details
        console.log("[Category Submit] Request:", requestUrl, requestOptions);
        res = await authFetch(requestUrl, requestOptions);
        // Log response details
        console.log("[Category Submit] Response status:", res.status);
        let resBody;
        try {
          resBody = await res.clone().json();
        } catch {
          resBody = await res.clone().text();
        }
        console.log("[Category Submit] Response body:", resBody);
        if (res.ok) {
          alert(editingCategoryId ? "Category updated successfully!" : "Category added successfully!");
          editingCategoryId = null;
          categoryNameInput.value = "";
          categoryDescriptionInput.value = "";
          const submitBtn = categoryForm.querySelector("button[type='submit']");
          submitBtn.textContent = "Add Category";
          submitBtn.style.background = "";
          fetchCategories();
        } else {
          let msg = "‚ùå Failed to save category.";
          if (resBody && typeof resBody === "object" && resBody.error) {
            msg += `\n${resBody.error}`;
          }
          alert(msg);
        }
      } catch (err) {
        alert(`‚ùå Error saving category: ${err.message}`);
        console.error("[Category Submit] Error:", err);
      }
    });

    async function deleteCategory(id) {
      if (!confirm("Are you sure you want to delete this category?")) return;
      try {
        const res = await authFetch(`/categories/${id}`, { method: "DELETE" });
        if (res.ok) {
          alert("‚úÖ Category deleted successfully!");
          fetchCategories();
        } else {
          let msg = "‚ùå Failed to delete category.";
          try {
            const errData = await res.json();
            if (errData && errData.error) msg += `\n${errData.error}`;
          } catch {}
          alert(msg);
        }
      } catch (err) {
        alert(`‚ùå Error deleting category: ${err.message}`);
        console.error("[Category Delete] Error:", err);
      }
    }

</script>

  <!-- Invite New User Modal -->
  <div class="modal fade" id="inviteUserModal" tabindex="-1" aria-labelledby="inviteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="inviteUserModalLabel">Invite New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="invite-user-form">
            <div class="mb-3">
              <label for="invite-email" class="form-label">Email Address</label>
              <input type="email" class="form-control" id="invite-email" placeholder="user@example.com" required>
            </div>
            <div class="mb-3">
              <label for="invite-role" class="form-label">Role</label>
              <select class="form-control" id="invite-role" required>
                <option value="bidder">Bidder</option>
                <option value="manager">Manager</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Send Invitation</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Existing User Modal -->
  <div class="modal fade" id="addExistingUserModal" tabindex="-1" aria-labelledby="addExistingUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addExistingUserModalLabel">Add Existing User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="add-existing-user-form">
            <div class="mb-3">
              <label for="existing-user-select" class="form-label">Select User</label>
              <select class="form-control" id="existing-user-select" required>
                <option value="">Select a user...</option>
              </select>
              <div class="form-text">Choose from users who are not currently in this organisation</div>
            </div>
            <button type="submit" class="btn btn-primary">Add User</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Enable messaging script -->
  <script src="/messages.js"></script>
</body>
</html>