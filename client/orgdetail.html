<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organisation Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <script>
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">üí¨</button></li>
      </ul>
    </div>
  </nav>

  <main>
    <div class="container">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <button type="button" onclick="goBack()" class="btn mb-2">‚Üê Back</button>
          <h2 class="card-title" id="page-title">Add Organisation</h2>
          <form id="org-form" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="org-name">Organisation Name:</label>
              <input type="text" id="org-name" name="name" required>
            </div>
            <div class="mb-3">
              <label for="org-currency">Currency:</label>
              <select id="org-currency" name="currency" required>
                <option value="">Select currency</option>
                <option value="USD">USD - US Dollar</option>
                <option value="GBP">GBP - British Pound</option>
                <option value="EUR">EUR - Euro</option>
                <option value="AUD">AUD - Australian Dollar</option>
                <option value="CAD">CAD - Canadian Dollar</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="org-type">Organisation Type:</label>
              <select id="org-type" name="type" required>
                <option value="client">Client (Buyer)</option>
                <option value="agency">Agency (Auction Manager)</option>
                <option value="supplier">Supplier (Bidder)</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="org-logo">Logo:</label>
              <input type="file" id="org-logo" name="logo" accept="image/*">
            </div>
            <div class="actions">
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
      <div id="categories-section" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="section-title">Categories</h2>
            <form id="category-form" class="mb-3">
              <input type="text" id="category-name" name="name" placeholder="Name" required>
              <input type="text" id="category-description" name="description" placeholder="Description" required>
              <button type="submit" class="btn btn-primary">Add Category</button>
            </form>
            <table id="categories-table" class="line-items-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Categories will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card shadow-sm" id="users-section" style="display:none;">
        <div class="card-body">
          <h2 class="section-title">Users</h2>
          <button class="btn btn-primary mb-3" id="invite-user-btn">Invite User</button>
          <table id="users-table" class="line-items-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
              </tr>
            </thead>
            <tbody>
              <!-- Users populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  
  <script>
    // Uses global apiBase defined in config.js
    const params = new URLSearchParams(window.location.search);
    const orgId = params.get("id");

    const form = document.getElementById("org-form");
    const title = document.getElementById("page-title");


    // Ensure authenticated via API and store current user
    async function ensureAuth() {
      try {
        const res = await authFetch("/users/me");
        if (!res.ok) throw new Error("unauthorized");
        const me = await res.json();
        window.currentUser = me;
        return true;
      } catch (e) {
        // Redirect to sign-in if token is missing/invalid/expired
        window.location.href = "/start.html";
        return false;
      }
    }

    // Load existing organisation if editing
    async function loadOrganisation() {
      if (!orgId) return;
      title.textContent = "Edit Organisation";

      const res = await authFetch(`/organisations/${orgId}`);
      const org = await res.json();

      document.getElementById("org-name").value = org.name || "";
      document.getElementById("org-currency").value = org.currency || "";
      document.getElementById("org-type").value = org.type || "client";

      // Show/hide sections based on org type
      if (org.type === 'client') {
        document.getElementById('categories-section').style.display = 'block';
        document.getElementById('users-section').style.display = 'none';
        fetchCategories();
      } else if (org.type === 'supplier') {
        document.getElementById('categories-section').style.display = 'none';
        document.getElementById('users-section').style.display = 'block';
        fetchUsers();
      } else {
        document.getElementById('categories-section').style.display = 'none';
        document.getElementById('users-section').style.display = 'none';
      }
    }

    // Handle create or update
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      let method = orgId ? "PUT" : "POST";
      let endpoint = orgId ? `/organisations/${orgId}` : "/organisations";

      const res = await authFetch(endpoint, { method, body: formData });
      if (res.ok) {
        alert("‚úÖ Organisation saved successfully!");
        const data = orgId ? { id: orgId } : await res.json();
        // Stay on the same page for supplier orgs; otherwise redirect to list
        const orgType = document.getElementById("org-type").value;
        if (orgType === "supplier") {
          window.location.href = `orgdetail.html?id=${data.id}`;
        } else {
          window.location.href = "organisations.html";
        }
      } else {
        alert("‚ùå Failed to save organisation.");
      }
    });

    function goBack() {
      window.history.back();
    }

    // Initialize page after successful auth
    (async function init() {
      const ok = await ensureAuth();
      if (!ok) return;
      await loadOrganisation();
      // fetchCategories() or fetchUsers() now handled within loadOrganisation()
    })();
    // Users management (for suppliers)
    async function fetchUsers() {
      if (!orgId) return;
      const res = await authFetch(`/organisations/${orgId}/users`);
      if (res.ok) {
        const users = await res.json();
        renderUsers(users);
      } else {
        console.error('Failed to load users');
      }
    }

    function renderUsers(users) {
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '';
      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="3">No users found.</td></tr>';
        return;
      }
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.first_name || ''} ${u.last_name || ''}</td><td>${u.email}</td><td>${u.role}</td>`;
        tbody.appendChild(tr);
      });
    }

    const inviteBtn = document.getElementById('invite-user-btn');
    if (inviteBtn) {
      inviteBtn.addEventListener('click', () => {
        const modalEl = document.getElementById('inviteUserModal');
        if (!modalEl || !window.bootstrap) return;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      });
    }

    const inviteForm = document.getElementById('invite-user-form');
    if (inviteForm) {
      inviteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('invite-name')?.value.trim();
        const email = document.getElementById('invite-email')?.value.trim();
        if (!email) return alert('Enter an email address.');
        const res = await authFetch('/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role: 'bidder', organisation_id: orgId })
        });
        if (res.ok) {
          alert('‚úÖ Invitation sent!');
          const modalEl = document.getElementById('inviteUserModal');
          if (modalEl && window.bootstrap) {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }
          fetchUsers();
        } else {
          alert('‚ùå Failed to send invite.');
        }
      });
    }

    // Categories management
    const categoryForm = document.getElementById("category-form");
    const categoryNameInput = document.getElementById("category-name");
    const categoryDescriptionInput = document.getElementById("category-description");
    const categoriesTableBody = document.querySelector("#categories-table tbody");

    let editingCategoryId = null;

    async function fetchCategories() {
      if (!orgId) {
        categoriesTableBody.innerHTML = '<tr><td colspan="3">Save organisation first to manage categories.</td></tr>';
        return;
      }
      try {
        const res = await authFetch(`/organisations/${orgId}/categories`);
        if (res.ok) {
          const categories = await res.json();
          renderCategories(categories);
        } else {
          let errorMsg = "Failed to load categories.";
          try {
            const errData = await res.json();
            if (errData && errData.error) errorMsg += ` (${errData.error})`;
          } catch {}
          categoriesTableBody.innerHTML = `<tr><td colspan="3">${errorMsg}</td></tr>`;
        }
      } catch (err) {
        categoriesTableBody.innerHTML = `<tr><td colspan="3">Error loading categories: ${err.message}</td></tr>`;
        console.error("Error fetching categories:", err);
      }
    }

    function renderCategories(categories) {
      if (!categories.length) {
        categoriesTableBody.innerHTML = '<tr><td colspan="3">No categories found.</td></tr>';
        return;
      }
      categoriesTableBody.innerHTML = "";
      categories.forEach(cat => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = cat.name;
        tr.appendChild(nameTd);

        const descTd = document.createElement("td");
        descTd.textContent = cat.description;
        tr.appendChild(descTd);

        const actionsTd = document.createElement("td");

        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è Edit";
        editBtn.className = "btn btn-primary";
        editBtn.addEventListener("click", () => startEditCategory(cat));
        actionsTd.appendChild(editBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è Delete";
        deleteBtn.className = "btn btn-danger";
        deleteBtn.addEventListener("click", () => deleteCategory(cat.id));
        actionsTd.appendChild(deleteBtn);

        tr.appendChild(actionsTd);

        categoriesTableBody.appendChild(tr);
      });
    }

    function startEditCategory(category) {
      editingCategoryId = category.id;
      categoryNameInput.value = category.name;
      categoryDescriptionInput.value = category.description;
      categoryForm.querySelector("button[type='submit']").textContent = "üíæ Save Changes";
    }

    categoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!orgId) {
        alert("Please save the organisation first before managing categories.");
        return;
      }

      const name = categoryNameInput.value.trim();
      const description = categoryDescriptionInput.value.trim();

      if (!name || !description) {
        alert("Please provide both name and description for the category.");
        return;
      }

      let res;
      try {
        // For debugging: show orgId before submit
        console.log("[Category Submit] orgId:", orgId);
        let requestUrl, requestOptions;
        if (editingCategoryId) {
          // Update existing category
          requestUrl = `/categories/${editingCategoryId}`;
          requestOptions = {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, description })
          };
        } else {
          // Create new category
          requestUrl = `/organisations/${orgId}/categories`;
          requestOptions = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, description })
          };
        }
        // Log request details
        console.log("[Category Submit] Request:", requestUrl, requestOptions);
        res = await authFetch(requestUrl, requestOptions);
        // Log response details
        console.log("[Category Submit] Response status:", res.status);
        let resBody;
        try {
          resBody = await res.clone().json();
        } catch {
          resBody = await res.clone().text();
        }
        console.log("[Category Submit] Response body:", resBody);
        if (res.ok) {
          alert(editingCategoryId ? "‚úÖ Category updated successfully!" : "‚úÖ Category added successfully!");
          editingCategoryId = null;
          categoryNameInput.value = "";
          categoryDescriptionInput.value = "";
          categoryForm.querySelector("button[type='submit']").textContent = "‚ûï Add Category";
          fetchCategories();
        } else {
          let msg = "‚ùå Failed to save category.";
          if (resBody && typeof resBody === "object" && resBody.error) {
            msg += `\n${resBody.error}`;
          }
          alert(msg);
        }
      } catch (err) {
        alert(`‚ùå Error saving category: ${err.message}`);
        console.error("[Category Submit] Error:", err);
      }
    });

    async function deleteCategory(id) {
      if (!confirm("Are you sure you want to delete this category?")) return;
      try {
        const res = await authFetch(`/categories/${id}`, { method: "DELETE" });
        if (res.ok) {
          alert("‚úÖ Category deleted successfully!");
          fetchCategories();
        } else {
          let msg = "‚ùå Failed to delete category.";
          try {
            const errData = await res.json();
            if (errData && errData.error) msg += `\n${errData.error}`;
          } catch {}
          alert(msg);
        }
      } catch (err) {
        alert(`‚ùå Error deleting category: ${err.message}`);
        console.error("[Category Delete] Error:", err);
      }
    }

</script>

  <div class="modal fade" id="inviteUserModal" tabindex="-1" aria-labelledby="inviteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="inviteUserModalLabel">Invite New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="invite-user-form">
            <div class="mb-3">
              <label for="invite-name" class="form-label">Name</label>
              <input type="text" class="form-control" id="invite-name" required>
            </div>
            <div class="mb-3">
              <label for="invite-email" class="form-label">Email</label>
              <input type="email" class="form-control" id="invite-email" required>
            </div>
            <button type="submit" class="btn btn-primary">Send Invite</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>
</html>