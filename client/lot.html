<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lot Details</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom Styles -->
  <link rel="stylesheet" href="css/style.css" />
  <script>
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
  <style>
    :root {
      --accent: #2563eb;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --hover: #f8fafc;
    }

    .lot-page {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px 24px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      color: var(--text-dark);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .page-header h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
      letter-spacing: -0.025em;
    }

    .btn-back {
      background-color: #ffffff;
      border: 1px solid var(--border);
      color: var(--text-dark);
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.9375rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .btn-back:hover {
      background-color: #f8fafc;
      border-color: var(--text-muted);
    }

    .lot-info-card {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    .lot-info-card h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0 0 8px 0;
      letter-spacing: -0.025em;
    }

    .lot-info-card p {
      color: var(--text-muted);
      margin: 0;
      line-height: 1.5;
    }

    .table-card {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    .table-card-header {
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .table-card-header h3 {
      font-size: 1.0625rem;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
      letter-spacing: -0.01em;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions button, .btn-action {
      background-color: var(--accent);
      border: none;
      color: #ffffff;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .actions button:hover, .btn-action:hover {
      background-color: #1d4ed8;
      transform: translateY(-1px);
    }

    .actions button.btn-secondary {
      background-color: #6b7280;
    }

    .actions button.btn-secondary:hover {
      background-color: #4b5563;
    }

    .table-card-body {
      padding: 20px;
      overflow-x: auto;
    }

    .line-items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .line-items-table thead th {
      background-color: #f8fafc;
      border: 1px solid var(--border);
      color: var(--text-dark);
      font-weight: 600;
      font-size: 0.8125rem;
      padding: 10px 8px;
      text-align: center;
      white-space: nowrap;
    }

    .line-items-table tbody td {
      padding: 8px;
      border: 1px solid var(--border);
      vertical-align: middle;
      min-width: 80px;
    }

    .line-items-table tbody tr:hover {
      background-color: var(--hover);
    }

    td.line-item-cell {
      cursor: text;
    }

    td.line-item-cell:empty::before {
      content: attr(data-placeholder);
      color: #9aa0a6;
    }

    td.line-item-cell:focus {
      outline: 2px solid var(--accent);
      outline-offset: -2px;
      background-color: #eff6ff;
    }

    .delete-btn-small {
      background-color: #ef4444;
      border: none;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .delete-btn-small:hover {
      background-color: #dc2626;
    }

    input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    #excelInput {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">ðŸ’¬</button></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="lot-page">
    <div class="page-header">
      <h1>Lot Details</h1>
      <button onclick="goBack()" class="btn-back">â¬… Back to Event</button>
    </div>

    <!-- Lot Information Card -->
    <div class="lot-info-card" id="lot-info">
      <h2 id="lot-title">Loading...</h2>
      <p id="lot-description"></p>
    </div>

    <!-- Line Items Table Card -->
    <div class="table-card">
      <div class="table-card-header">
        <h3>Line Items</h3>
        <div class="actions">
          <button onclick="addRow()">âž• Add Row</button>
          <button onclick="saveAll()">ðŸ’¾ Save Changes</button>
          <button onclick="exportExcel()" class="btn-secondary">ðŸ“¤ Export Excel</button>
          <input type="file" id="excelInput" accept=".xlsx" onchange="importExcel(event)" />
          <button onclick="document.getElementById('excelInput').click()" class="btn-secondary">ðŸ“¥ Import Excel</button>
        </div>
      </div>
      <div class="table-card-body">
        <table class="line-items-table" id="line-items-table">
        <table class="line-items-table" id="line-items-table">
          <thead>
            <tr>
              <th colspan="7">Core Info</th>
              <th colspan="6">Bid Settings</th>
              <th colspan="4">Evaluative Settings</th>
              <th colspan="3">Bid Interface Visibility</th>
              <th rowspan="2">Actions</th>
            </tr>
            <tr>
              <!-- Core Info -->
              <th>Item #</th>
              <th>Item Name</th>
              <th>Group #</th>
              <th>Description</th>
              <th>Qty</th>
              <th>UOM</th>

              <!-- Bid Settings -->
              <th>Input</th>
              <th>Required</th>
              <th>Ties</th>
              <th>.00</th>
              <th>Decrement</th>
              <th>Opening</th>

              <!-- Evaluative Settings -->
              <th>Baseline</th>
              <th>Ext Qty</th>
              <th>Ext Base</th>
              <th>Reserve</th>
              <th>Incumbent</th>

              <!-- Bid Interface Visibility -->
              <th>Weighting</th>
              <th>Opening</th>
              <th>Reserve</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const lotId = params.get("id");

    let currencySymbol = 'Â£';
    // Helper function to map currency codes to symbols
    function getCurrencySymbol(code) {
      const map = {
        GBP: 'Â£',
        USD: '$',
        EUR: 'â‚¬',
        JPY: 'Â¥',
        AUD: 'A$',
        CAD: 'C$',
        CHF: 'CHF',
        CNY: 'Â¥',
        SEK: 'kr',
        NZD: 'NZ$'
      };
      return map[code] || 'Â£';
    }

    async function loadLot() {
      const res = await authFetch(`/lots/${lotId}`);
      const lot = await res.json();
      document.getElementById("lot-title").textContent = lot.title;
      document.getElementById("lot-description").textContent = lot.description || "";

      // Fetch event to get currency code and symbol
      if (lot.event_id) {
        try {
          const eventRes = await authFetch(`/events/${lot.event_id}`);
          const eventData = await eventRes.json();
          if (lot.currency_code) {
            currencySymbol = getCurrencySymbol(lot.currency_code.toUpperCase());
          } else if (eventData.currency || eventData.currency_code) {
            const code = (eventData.currency || eventData.currency_code).toUpperCase();
            currencySymbol = getCurrencySymbol(code);
          } else {
            currencySymbol = 'Â£';
          }
          updateAllPlaceholders();
        } catch (err) {
          console.error("Error fetching event for currency code:", err);
        }
      }


      return lot;
    }

    // Helper to format placeholder text given decimals and currency symbol
    function formatPlaceholder(decimals) {
      const decimalCount = Number.isInteger(decimals) && decimals >= 0 ? decimals : 2;
      if (decimalCount === 0) {
        return currencySymbol + '0';
      } else {
        return currencySymbol + '0.' + '0'.repeat(decimalCount);
      }
    }

    function updateAllPlaceholders() {
      const rows = document.querySelectorAll("#line-items-table tbody tr");
      rows.forEach(tr => {
        let decimalsCell = tr.querySelector('td[data-field="decimals"]');
        let decimals = 2;
        if (decimalsCell) {
          const val = parseInt(decimalsCell.textContent.trim());
          if (!isNaN(val) && val >= 0) decimals = val;
        }
        const fields = ["decrement", "baseline", "ext_baseline", "opening_value", "reserve_value"];
        fields.forEach(field => {
          const cell = tr.querySelector(`td[data-field="${field}"]`);
          if (cell) cell.setAttribute('data-placeholder', formatPlaceholder(decimals));
        });
      });
    }

    function updateExtBaseline(tr) {
      const baselineCell = tr.querySelector('td[data-field="baseline"]');
      const extQtyCell = tr.querySelector('td[data-field="ext_quantity"]');
      const extBaseCell = tr.querySelector('td[data-field="ext_baseline"]');
      const decimalsCell = tr.querySelector('td[data-field="decimals"]');
      if (!baselineCell || !extQtyCell || !extBaseCell) return;
      let baselineText = baselineCell.textContent.trim().replace(/[^0-9.\-]/g, "");
      const baseline = parseFloat(baselineText) || 0;
      const qty = parseFloat(extQtyCell.textContent.trim()) || 0;
      const decimals = parseInt(decimalsCell?.textContent.trim()) || 2;
      const result = baseline * qty;
      extBaseCell.textContent = result ? (currencySymbol + result.toFixed(decimals)) : '';
    }

    function formatNumericValue(value, decimals) {
      if (isNaN(value) || value === null || value === '') return '';
      const num = parseFloat(value);
      return num.toFixed(decimals);
    }

    async function loadLineItems() {
      const res = await authFetch(`/lots/${lotId}/line-items`);
      const items = await res.json();
      const tbody = document.querySelector("#line-items-table tbody");
      tbody.innerHTML = "";
      items.forEach((item) => addRow(item));
      updateAllPlaceholders();
      // Ensure proper numeric formatting with currency symbol and decimals after loading or saving
      const rows = document.querySelectorAll("#line-items-table tbody tr");
      rows.forEach(tr => {
        const decimalsCell = tr.querySelector('td[data-field="decimals"]');
        const decimals = decimalsCell ? parseInt(decimalsCell.textContent.trim()) || 2 : 2;
        ["decrement", "baseline", "ext_baseline", "opening_value", "reserve_value"].forEach(field => {
          const cell = tr.querySelector(`td[data-field="${field}"]`);
          if (cell && cell.textContent.trim() !== '') {
            let num = parseFloat(cell.textContent.replace(/[^0-9.\-]/g, ''));
            if (!isNaN(num)) cell.textContent = currencySymbol + num.toFixed(decimals);
          }
        });
      });
    }

    function addRow(item = {}) {
      const tbody = document.querySelector("#line-items-table tbody");
      const tr = document.createElement("tr");

      const columns = [
        "item_number", "item_name", "group_number", "description", "quantity", "uom",
        "input", "required", "ties", "decimals", "decrement", "opening_value",
        "baseline", "ext_quantity", "ext_baseline", "reserve_value", "incumbent",
        "weighting_visible", "opening_visible", "reserve_visible"
      ];

      columns.forEach((col) => {
        const td = document.createElement("td");
        td.classList.add("line-item-cell");
        if (col === "") {
          td.textContent = ""; // empty cell for header alignment
          td.contentEditable = false;
        } else if (["weighting_visible", "opening_visible", "reserve_visible"].includes(col)) {
          // Render as checkbox
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = !!item[col];
          checkbox.addEventListener("change", () => {
            td.dataset.value = checkbox.checked;
          });
          td.appendChild(checkbox);
          td.contentEditable = false;
          td.dataset.field = col;
          td.dataset.value = checkbox.checked;
          tr.appendChild(td);
          return;
        } else {
          td.contentEditable = true;
          td.dataset.field = col;
          td.textContent = item[col] !== undefined && item[col] !== null ? item[col] : "";
          if (
            ["decrement", "baseline", "ext_baseline", "opening_value", "reserve_value"].includes(col) &&
            item[col] !== undefined && item[col] !== null && item[col] !== ""
          ) {
            let val = parseFloat(item[col]);
            if (!isNaN(val)) {
              const decimalsCell = tr.querySelector('td[data-field="decimals"]');
              const decimals = decimalsCell ? parseInt(decimalsCell.textContent.trim()) || 2 : 2;
              td.textContent = currencySymbol + val.toFixed(decimals);
            }
          }
          // Set placeholder for decrement, baseline, ext_baseline, opening_value, reserve_value based on decimals and currency symbol
          if (["decrement", "baseline", "ext_baseline", "opening_value", "reserve_value"].includes(col)) {
            // placeholders will be set after row creation
          }
          if (col === "decimals") {
            // Add event listener to update placeholders on decimals change
            td.addEventListener("input", () => {
              let decimals = parseInt(td.textContent.trim());
              if (isNaN(decimals) || decimals < 0) decimals = 2;
              // Update placeholders for decrement, baseline, ext_baseline, opening_value, reserve_value cells in this row
              const fields = ["decrement", "baseline", "ext_baseline", "opening_value", "reserve_value"];
              fields.forEach(field => {
                const cell = tr.querySelector(`td[data-field="${field}"]`);
                if (cell) cell.setAttribute('data-placeholder', formatPlaceholder(decimals));
              });
            });
          }
        }
        tr.appendChild(td);
      });

      // After all cells created, set placeholders for decrement, baseline, ext_baseline, opening_value, reserve_value based on decimals
      let decimalsCell = tr.querySelector('td[data-field="decimals"]');
      let decimals = 2;
      if (decimalsCell) {
        const val = parseInt(decimalsCell.textContent.trim());
        if (!isNaN(val) && val >= 0) decimals = val;
      }
      const decrementCell = tr.querySelector('td[data-field="decrement"]');
      const baselineCell = tr.querySelector('td[data-field="baseline"]');
      const extBaselineCell = tr.querySelector('td[data-field="ext_baseline"]');
      const openingCell = tr.querySelector('td[data-field="opening_value"]');
      const reserveCell = tr.querySelector('td[data-field="reserve_value"]');
      if (decrementCell) decrementCell.setAttribute('data-placeholder', formatPlaceholder(decimals));
      if (baselineCell) baselineCell.setAttribute('data-placeholder', formatPlaceholder(decimals));
      if (extBaselineCell) extBaselineCell.setAttribute('data-placeholder', formatPlaceholder(decimals));
      if (openingCell) openingCell.setAttribute('data-placeholder', formatPlaceholder(decimals));
      if (reserveCell) reserveCell.setAttribute('data-placeholder', formatPlaceholder(decimals));

      // --- Enforce decimal precision limit for numeric fields ---
      function enforceDecimalLimit(cell) {
        cell.addEventListener("beforeinput", (e) => {
          const decimalsCell = tr.querySelector('td[data-field="decimals"]');
          const decimals = parseInt(decimalsCell?.textContent.trim()) || 2;
          const text = cell.textContent;
          const selection = window.getSelection();
          const cursorPos = selection.anchorOffset;
          const newText =
            text.slice(0, cursorPos) + e.data + text.slice(cursorPos);
          const clean = newText.replace(/[^0-9.]/g, "");
          const regex = new RegExp(`^(\\d+)(\\.(\\d{0,${decimals}})?)?$`);
          if (clean && !regex.test(clean)) {
            e.preventDefault(); // stop extra input but keep caret in place
          }
        });
      }
      [decrementCell, baselineCell, extBaselineCell, openingCell, reserveCell].forEach(c => {
        if (c) enforceDecimalLimit(c);
      });
      // ---------------------------------------------------------

      // Add event listeners to update ext_baseline when baseline or ext_quantity changes
      const extQtyCell = tr.querySelector('td[data-field="ext_quantity"]');
      if (baselineCell) {
        baselineCell.addEventListener("input", () => {
          updateExtBaseline(tr);
        });
      }
      if (extQtyCell) {
        extQtyCell.addEventListener("input", () => {
          updateExtBaseline(tr);
        });
      }

      if (baselineCell) {
        baselineCell.addEventListener('blur', () => {
          const decimalsCell = tr.querySelector('td[data-field="decimals"]');
          const decimals = parseInt(decimalsCell?.textContent.trim()) || 2;
          let value = baselineCell.textContent.trim().replace(/[^0-9.\-]/g, '');
          if (value !== '') {
            baselineCell.textContent = currencySymbol + formatNumericValue(value, decimals);
            updateExtBaseline(tr);
          }
        });
      }

      if (decrementCell) {
        decrementCell.addEventListener('blur', () => {
          const decimalsCell = tr.querySelector('td[data-field="decimals"]');
          const decimals = parseInt(decimalsCell?.textContent.trim()) || 2;
          let value = decrementCell.textContent.trim().replace(/[^0-9.\-]/g, '');
          if (value !== '') {
            decrementCell.textContent = currencySymbol + formatNumericValue(value, decimals);
          }
        });
      }

      if (extBaselineCell) {
        extBaselineCell.addEventListener('blur', () => {
          const decimalsCell = tr.querySelector('td[data-field="decimals"]');
          const decimals = parseInt(decimalsCell?.textContent.trim()) || 2;
          let value = extBaselineCell.textContent.trim().replace(/[^0-9.\-]/g, '');
          if (value !== '') {
            extBaselineCell.textContent = currencySymbol + formatNumericValue(value, decimals);
          }
        });
      }

      if (openingCell) {
        openingCell.addEventListener('blur', () => {
          const decimalsCell = tr.querySelector('td[data-field="decimals"]');
          const decimals = parseInt(decimalsCell?.textContent.trim()) || 2;
          let value = openingCell.textContent.trim().replace(/[^0-9.\-]/g, '');
          if (value !== '') {
            openingCell.textContent = currencySymbol + formatNumericValue(value, decimals);
          }
        });
      }

      if (reserveCell) {
        reserveCell.addEventListener('blur', () => {
          const decimalsCell = tr.querySelector('td[data-field="decimals"]');
          const decimals = parseInt(decimalsCell?.textContent.trim()) || 2;
          let value = reserveCell.textContent.trim().replace(/[^0-9.\-]/g, '');
          if (value !== '') {
            reserveCell.textContent = currencySymbol + formatNumericValue(value, decimals);
          }
        });
      }

      // Update ext_baseline initially
      updateExtBaseline(tr);

      const actions = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "ðŸ—‘";
      delBtn.className = "delete-btn-small";
      delBtn.onclick = async () => {
        if (item.id && confirm("Delete this line item?")) {
          await authFetch(`/line-items/${item.id}`, { method: "DELETE" });
          tr.remove();
        } else {
          tr.remove();
        }
      };
      actions.appendChild(delBtn);
      tr.appendChild(actions);

      tr.dataset.id = item.id || "";
      tbody.appendChild(tr);
    }

    async function saveAll() {
      const rows = document.querySelectorAll("#line-items-table tbody tr");
      for (const row of rows) {
        const cells = row.querySelectorAll("td[data-field]");
        const payload = {};
        cells.forEach((cell) => {
          let value;
          if (["weighting_visible", "opening_visible", "reserve_visible"].includes(cell.dataset.field)) {
            value = cell.dataset.value === "true";
          } else {
            value = cell.textContent.trim();
            // Remove currency symbols and non-numeric characters except digits, minus, and decimal point
            if (["decrement", "baseline", "ext_baseline", "opening_value", "reserve_value"].includes(cell.dataset.field)) {
              value = value.replace(/[^0-9.\-]/g, "");
              if (!isNaN(value) && value !== "") value = parseFloat(value);
            }
          }
          payload[cell.dataset.field] = value;
        });

        if (row.dataset.id) {
          // update
          await authFetch(`/line-items/${row.dataset.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        } else {
          // create
          const res = await authFetch(`/lots/${lotId}/line-items`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const newItem = await res.json();
          row.dataset.id = newItem.id;
        }
      }
      alert("âœ… Line items saved!");
      loadLineItems();
    }
//back to lots in event
    async function goBack() {
      try {
        const res = await authFetch(`/lots/${lotId}`);
        const lot = await res.json();
        if (lot.event_id) {
          window.location.href = `event.html?id=${lot.event_id}&tab=lots`;
        } else {
          window.location.href = "events.html";
        }
      } catch (err) {
        console.error("Error fetching event ID for lot:", err);
        window.location.href = "events.html";
      }
    }

    async function exportExcel() {
      const res = await authFetch(`/lots/${lotId}/line-items/export`);
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `lot_${lotId}_line_items.xlsx`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    async function importExcel(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        const formData = new FormData();
        formData.append("file", file);
        
        const response = await authFetch(`/lots/${lotId}/line-items/import`, {
          method: "POST",
          body: formData
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(errorData.error || `Import failed with status ${response.status}`);
        }
        
        const result = await response.json();
        alert("âœ… Excel imported successfully!");
        loadLineItems();
      } catch (error) {
        console.error("Import error:", error);
        alert("âŒ Failed to import Excel file: " + error.message);
      } finally {
        // Clear the file input so the same file can be selected again
        event.target.value = '';
      }
    }

    (async () => {
      await loadLot();
      await loadLineItems();
    })();
  </script>

  <!-- Footer -->
  <footer>
    <p>Tendersmith Â© 2025</p>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Enable messaging script -->
  <script src="/messages.js"></script>
</body>
</html>