<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create New Event</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script>
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
  <style>
    form {
      width: 60%;
      margin: 30px auto;
      text-align: left;
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">💬</button></li>
      </ul>
    </div>
  </nav>

  <main>
    <header>
      <h1>Create New Event</h1>
    </header>
    <form id="create-event-form">
      <label for="event-name">Event Name:</label>
      <input type="text" id="event-name" required>

      <label for="organisation">Organisation:</label>
      <select id="organisation" required>
        <option value="">Select Organisation</option>
      </select>

      <label for="category">Category:</label>
      <select id="category" required>
        <option value="">Select Category</option>
      </select>

      <label for="currency">Currency:</label>
      <select id="currency" required>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
      </select>

      <label for="support-contact">Support Contact:</label>
      <input type="text" id="support-contact" placeholder="e.g. support@company.com">

      <label for="bid-manager">Bid Manager Contact:</label>
      <input type="text" id="bid-manager" placeholder="e.g. jane@company.com">

      <label for="auction-date">Auction Start Date:</label>
      <input type="date" id="auction-date" required>

      <label for="auction-time">Auction Start Time:</label>
      <input type="time" id="auction-time" required>

      <label for="auction-duration">Auction Duration (minutes):</label>
      <input type="number" id="auction-duration" placeholder="e.g. 30" min="1" required>

      <label for="extension-time">Extension Time (seconds):</label>
      <input type="number" id="extension-time" placeholder="e.g. 120" min="1" required>

      <label for="extension-threshold">Extension Trigger Threshold (seconds):</label>
      <input type="number" id="extension-threshold" placeholder="e.g. 60" min="1" required>

      <label for="description">Event Description:</label>
      <textarea id="description" rows="4" placeholder="Enter a short summary..."></textarea>

      <label for="sealed">
        <input type="checkbox" id="sealed" name="sealed">
        Sealed?
      </label>
      <small style="display:block; margin-top:4px; color:#555;">
        Make this event invite only and anonymise bids.
      </small>

      <button type="submit">Create Event</button>
    </form>
  </main>

  <script>
    const form = document.getElementById('create-event-form');
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get('id');
    const titleEl = document.getElementById('event-name');
    const orgEl = document.getElementById('organisation');
    const catEl = document.getElementById('category');
    const currencyEl = document.getElementById('currency');
    const supportEl = document.getElementById('support-contact');
    const managerEl = document.getElementById('bid-manager');
    const descEl = document.getElementById('description');
    const header = document.querySelector('header h1') || { textContent: '' };
    const submitBtn = form.querySelector('button');
    const auctionDateEl = document.getElementById('auction-date');
    const auctionTimeEl = document.getElementById('auction-time');

    async function fetchOrganisations() {
      try {
        const res = await authFetch('/organisations');
        if (!res.ok) throw new Error('Failed to load organisations');
        const organisations = await res.json();
        orgEl.innerHTML = '<option value="">Select Organisation</option>';
        organisations.forEach(org => {
          const option = document.createElement('option');
          option.value = org.id;
          option.textContent = org.name;
          orgEl.appendChild(option);
        });
      } catch (err) {
        alert('Error loading organisations: ' + err.message);
      }
    }

    async function fetchCategories(orgId) {
      catEl.innerHTML = '<option value="">Select Category</option>';
      if (!orgId) return;
      try {
        const res = await authFetch(`/organisations/${orgId}/categories`);
        if (!res.ok) throw new Error('Failed to load categories');
        const categories = await res.json();
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.name;
          catEl.appendChild(option);
        });
      } catch (err) {
        alert('Error loading categories: ' + err.message);
      }
    }

    // Edit mode setup
    if (eventId) {
      header.textContent = '✏️ Edit Event';
      submitBtn.textContent = 'Save Changes';
    }

    async function loadEventDetails() {
      try {
        const res = await authFetch(`/events/${eventId}`);
        if (!res.ok) throw new Error('Failed to load event');
        const event = await res.json();
        titleEl.value = event.title;
        await fetchOrganisations();
        orgEl.value = event.organisation_id;
        await fetchCategories(event.organisation_id);
        catEl.value = event.category_id;
        currencyEl.value = event.currency;
        supportEl.value = event.support_contact;
        managerEl.value = event.bid_manager;
        descEl.value = event.description;
        const sealedCheckbox = document.getElementById('sealed');
        sealedCheckbox.checked = event.type === 'sealed';
        auctionDateEl.value = event.auction_time ? new Date(event.auction_time).toISOString().split('T')[0] : '';
        auctionTimeEl.value = event.auction_time ? new Date(event.auction_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
        // Populate auction duration and extension fields if present
        if (typeof event.auction_duration !== "undefined" && event.auction_duration !== null) {
          document.getElementById('auction-duration').value = event.auction_duration;
        }
        if (typeof event.extension_time !== "undefined" && event.extension_time !== null) {
          document.getElementById('extension-time').value = event.extension_time;
        }
        if (typeof event.extension_threshold !== "undefined" && event.extension_threshold !== null) {
          document.getElementById('extension-threshold').value = event.extension_threshold;
        }
      } catch (err) {
        alert('Error loading event details: ' + err.message);
      }
    }

    orgEl.addEventListener('change', async () => {
      await fetchCategories(orgEl.value);
    });

    window.addEventListener('DOMContentLoaded', async () => {
      if (!eventId) {
        await fetchOrganisations();
      } else {
        await loadEventDetails();
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const auctionDate = auctionDateEl.value;
      const auctionTime = auctionTimeEl.value;
      const auction_time = new Date(`${auctionDate}T${auctionTime}`).toISOString();

      const eventData = {
        title: titleEl.value,
        organisation_id: orgEl.value,
        category_id: catEl.value,
        currency: currencyEl.value,
        support_contact: supportEl.value,
        bid_manager: managerEl.value,
        auction_duration: Number(document.getElementById('auction-duration').value),
        extension_time: Number(document.getElementById('extension-time').value),
        extension_threshold: Number(document.getElementById('extension-threshold').value),
        description: descEl.value,
        auction_time,
        type: document.getElementById('sealed').checked ? 'sealed' : 'open'
      };

      const method = eventId ? 'PUT' : 'POST';
      const url = eventId
        ? `/events/${eventId}`
        : '/events';

      try {
        const res = await authFetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(eventData)
        });

        if (res.ok) {
          const savedEvent = await res.json();
          alert(eventId ? 'Event updated successfully!' : 'Event created successfully!');
          window.location.href = `event.html?id=${savedEvent.id}`;
        } else {
          const err = await res.json();
          alert('Error saving event: ' + (err.error || res.statusText));
        }
      } catch (err) {
        alert('Failed to connect to server: ' + err.message);
      }
    });
  </script>
  <footer>
    <p>Tendersmith © 2025</p>
  </footer>
</footer>
  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Enable messaging script -->
  <script src="/messages.js"></script>
  <!-- Bootstrap JS (for optional interactivity) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>