<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create New Event</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/eventdetail.css">
  <script>
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">ðŸ’¬</button></li>
      </ul>
    </div>
  </nav>

  <div class="event-detail-page">
    <div class="page-header">
      <h1 id="page-title">Create New Event</h1>
    </div>

    <div class="event-overview-card">
      <form id="create-event-form">
        <div class="form-grid">
          <!-- Basic Information -->
          <div class="form-section">
            <h3 class="section-title">Basic Information</h3>
            
            <div class="form-group">
              <label for="event-name" class="form-label">Event Name</label>
              <input type="text" id="event-name" class="form-input" required>
            </div>

            <div class="form-group">
              <label for="organisation" class="form-label">Organisation</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <select id="organisation" class="form-select" required style="flex: 1;">
                  <option value="">Select Organisation</option>
                </select>
                <button type="button" id="create-org-btn" class="btn-secondary" style="white-space: nowrap; padding: 10px 16px;">+ New Organisation</button>
              </div>
            </div>

            <div class="form-group">
              <label for="category" class="form-label">Category</label>
              <select id="category" class="form-select" required>
                <option value="">Select Category</option>
              </select>
            </div>

            <div class="form-group">
              <label for="currency" class="form-label">Currency</label>
              <select id="currency" class="form-select" required>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
            </div>

            <div class="form-group">
              <label for="description" class="form-label">Event Description</label>
              <textarea id="description" class="form-textarea" rows="4" placeholder="Enter a short summary..."></textarea>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="form-section">
            <h3 class="section-title">Contact Information</h3>
            
            <div class="form-group">
              <label for="support-contact" class="form-label">Support Contact</label>
              <input type="text" id="support-contact" class="form-input" placeholder="e.g. support@company.com">
            </div>

            <div class="form-group">
              <label for="bid-manager" class="form-label">Bid Manager Contact</label>
              <input type="text" id="bid-manager" class="form-input" placeholder="e.g. jane@company.com">
            </div>
          </div>

          <!-- Auction Settings -->
          <div class="form-section">
            <h3 class="section-title">Auction Settings</h3>
            
            <div class="form-group">
              <label for="auction-date" class="form-label">Auction Start Date</label>
              <input type="date" id="auction-date" class="form-input" required>
            </div>

            <div class="form-group">
              <label for="auction-time" class="form-label">Auction Start Time</label>
              <input type="time" id="auction-time" class="form-input" required>
            </div>

            <div class="form-group">
              <label for="auction-duration" class="form-label">Auction Duration (minutes)</label>
              <input type="number" id="auction-duration" class="form-input" placeholder="e.g. 30" min="1" required>
            </div>

            <div class="form-group">
              <label for="extension-time" class="form-label">Extension Time (seconds)</label>
              <input type="number" id="extension-time" class="form-input" placeholder="e.g. 120" min="1" required>
            </div>

            <div class="form-group">
              <label for="extension-threshold" class="form-label">Extension Trigger Threshold (seconds)</label>
              <input type="number" id="extension-threshold" class="form-input" placeholder="e.g. 60" min="1" required>
            </div>

            <div class="form-group">
              <div class="checkbox-wrapper">
                <input type="checkbox" id="sealed" name="sealed" class="form-checkbox">
                <label for="sealed" class="checkbox-label">
                  Sealed Event
                  <span class="checkbox-help">Make this event invite only and anonymise bids</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Create Event</button>
          <button type="button" class="btn-secondary" onclick="window.location.href='events.html'">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const form = document.getElementById('create-event-form');
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get('id');
    const titleEl = document.getElementById('event-name');
    const orgEl = document.getElementById('organisation');
    const catEl = document.getElementById('category');
    const currencyEl = document.getElementById('currency');
    const supportEl = document.getElementById('support-contact');
    const managerEl = document.getElementById('bid-manager');
    const descEl = document.getElementById('description');
    const pageTitle = document.getElementById('page-title');
    const submitBtn = form.querySelector('button[type="submit"]');
    const auctionDateEl = document.getElementById('auction-date');
    const auctionTimeEl = document.getElementById('auction-time');

    // Store organisations data for currency lookup
    let organisationsData = [];

    async function fetchOrganisations() {
      try {
        const res = await authFetch('/organisations?type=client');
        if (!res.ok) throw new Error('Failed to load client organisations');
        const organisations = await res.json();
        organisationsData = organisations; // Store for later use
        orgEl.innerHTML = '<option value=\"\">Select Client Organisation</option>';
        organisations.forEach(org => {
          const option = document.createElement('option');
          option.value = org.id;
          option.textContent = org.name;
          option.dataset.currency = org.currency || ''; // Store currency in dataset
          orgEl.appendChild(option);
        });
      } catch (err) {
        alert('Error loading organisations: ' + err.message);
      }
    }

    async function fetchCategories(orgId) {
      catEl.innerHTML = '<option value="">Select Category</option>';
      if (!orgId) return;
      try {
        const res = await authFetch(`/organisations/${orgId}/categories`);
        if (!res.ok) throw new Error('Failed to load categories');
        const categories = await res.json();
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.name;
          catEl.appendChild(option);
        });
      } catch (err) {
        alert('Error loading categories: ' + err.message);
      }
    }

    // Edit mode setup
    if (eventId) {
      pageTitle.textContent = 'Edit Event';
      submitBtn.textContent = 'Save Changes';
    }

    async function loadEventDetails() {
      try {
        const res = await authFetch(`/events/${eventId}`);
        if (!res.ok) throw new Error('Failed to load event');
        const event = await res.json();
        titleEl.value = event.title;
        await fetchOrganisations();
        orgEl.value = event.organisation_id;
        await fetchCategories(event.organisation_id);
        catEl.value = event.category_id;
        currencyEl.value = event.currency;
        supportEl.value = event.support_contact;
        managerEl.value = event.bid_manager;
        descEl.value = event.description;
        const sealedCheckbox = document.getElementById('sealed');
        sealedCheckbox.checked = event.type === 'sealed';
        
        // Parse auction time correctly - treat as local time
        if (event.auction_time) {
          const auctionDateTime = new Date(event.auction_time);
          // Get the date in local timezone format (YYYY-MM-DD)
          const year = auctionDateTime.getFullYear();
          const month = String(auctionDateTime.getMonth() + 1).padStart(2, '0');
          const day = String(auctionDateTime.getDate()).padStart(2, '0');
          auctionDateEl.value = `${year}-${month}-${day}`;
          
          // Get the time in local timezone format (HH:MM)
          const hours = String(auctionDateTime.getHours()).padStart(2, '0');
          const minutes = String(auctionDateTime.getMinutes()).padStart(2, '0');
          auctionTimeEl.value = `${hours}:${minutes}`;
        }
        
        // Populate auction duration and extension fields if present
        if (typeof event.auction_duration !== "undefined" && event.auction_duration !== null) {
          document.getElementById('auction-duration').value = event.auction_duration;
        }
        if (typeof event.extension_time !== "undefined" && event.extension_time !== null) {
          document.getElementById('extension-time').value = event.extension_time;
        }
        if (typeof event.extension_threshold !== "undefined" && event.extension_threshold !== null) {
          document.getElementById('extension-threshold').value = event.extension_threshold;
        }
      } catch (err) {
        alert('Error loading event details: ' + err.message);
      }
    }

    orgEl.addEventListener('change', async () => {
      await fetchCategories(orgEl.value);
      
      // Auto-set currency based on selected organisation
      if (orgEl.value) {
        const selectedOrg = organisationsData.find(org => org.id == orgEl.value);
        if (selectedOrg && selectedOrg.currency) {
          currencyEl.value = selectedOrg.currency;
        }
      }
    });

    // Create new organisation button
    document.getElementById('create-org-btn').addEventListener('click', () => {
      window.location.href = 'orgdetail.html';
    });

    window.addEventListener('DOMContentLoaded', async () => {
      if (!eventId) {
        await fetchOrganisations();
      } else {
        await loadEventDetails();
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const auctionDate = auctionDateEl.value;
      const auctionTime = auctionTimeEl.value;
      
      if (!auctionDate || !auctionTime) {
        alert('Please provide both auction date and time');
        return;
      }
      
      // Create datetime string in ISO format but preserve local timezone
      const auction_time = `${auctionDate}T${auctionTime}:00`;

      const eventData = {
        title: titleEl.value,
        organisation_id: parseInt(orgEl.value),
        category_id: parseInt(catEl.value),
        currency: currencyEl.value,
        support_contact: supportEl.value || '',
        bid_manager: managerEl.value || '',
        auction_duration: Number(document.getElementById('auction-duration').value),
        extension_time: Number(document.getElementById('extension-time').value),
        extension_threshold: Number(document.getElementById('extension-threshold').value),
        description: descEl.value || '',
        auction_time,
        type: document.getElementById('sealed').checked ? 'sealed' : 'open'
      };

      const method = eventId ? 'PUT' : 'POST';
      const url = eventId
        ? `/events/${eventId}`
        : '/events';

      try {
        const res = await authFetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(eventData)
        });

        if (res.ok) {
          const savedEvent = await res.json();
          alert(eventId ? 'Event updated successfully!' : 'Event created successfully!');
          window.location.href = `event.html?id=${savedEvent.id}`;
        } else {
          const err = await res.json();
          alert('Error saving event: ' + (err.error || res.statusText));
        }
      } catch (err) {
        alert('Failed to connect to server: ' + err.message);
      }
    });
  </script>

  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Enable messaging script -->
  <script src="/messages.js"></script>
  <!-- Bootstrap JS (for optional interactivity) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>