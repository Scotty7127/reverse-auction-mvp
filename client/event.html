<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Details</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/eventdetail.css">
  <script>
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">ðŸ’¬</button></li>
      </ul>
    </div>
  </nav>

  <div class="event-tabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="lots">Lots</div>
    <div class="tab" data-tab="lines">All Line Items</div>
    <div class="tab" data-tab="members">Members</div>
    <div class="tab" data-tab="docs">RFQ</div>
    <div class="tab" data-tab="pricing">Pricing</div>
  </div>

  <main class="event-detail-page">
    <div class="event-content">
    <section id="overview" class="tab-content active">
      <div class="event-overview-card" id="event-details">
        <div class="loading-state">Loading event...</div>
      </div>
    </section>

    <section id="lots" class="tab-content">
      <div class="section-header">
        <h2>Lots</h2>
        <button id="create-lot-btn" class="btn-primary">Create New Lot</button>
      </div>
      <div id="lots-list" class="lots-container"></div>
    </section>

    <section id="lines" class="tab-content">
      <h2>All Line Items</h2>
      <p class="section-description">All line items from all lots will be listed here</p>
    </section>

    <section id="members" class="tab-content">
      <h2>Event Members</h2>
      <div class="members-grid">
        <div class="members-card">
          <div class="card-header-custom">
            <h3 class="card-title">Managers</h3>
          </div>
          <div class="card-content">
            <div id="managerList"><p class="loading-text">Loading...</p></div>
          </div>
        </div>
        <div class="members-card">
          <div class="card-header-custom">
            <h3 class="card-title">Bidders</h3>
          </div>
          <div class="card-content">
            <p class="bidders-instruction">Select suppliers to assign line items, weighting, and opening bids.</p>
            <div id="bidderList"><p class="loading-text">Loading...</p></div>
          </div>
        </div>
      </div>
      <div class="section-actions">
        <button id="save-members-btn" class="btn-primary">Save Assignments</button>
      </div>
    </section>

    <section id="docs" class="tab-content">
      <h2>RFQ Management</h2>
      <div class="rfq-card">
        <div class="card-header-custom">
          <h4 class="card-title">Information / Email Content</h4>
        </div>
        <div class="card-content">
          <textarea id="rfq-info" class="rfq-textarea" rows="6" placeholder="Write the email content that will be sent to bidders..."></textarea>
        </div>
      </div>
      
      <div class="rfq-card">
        <div class="card-header-custom">
          <h4 class="card-title">Schedule</h4>
        </div>
        <div class="card-content">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Publish Date & Time:</label>
              <input type="datetime-local" id="rfq-publish" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">Deadline for Responses:</label>
              <input type="datetime-local" id="rfq-deadline" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">Reminder Time:</label>
              <input type="datetime-local" id="rfq-reminder" class="form-input" />
              <small class="form-hint">Defaults to 1 day before deadline</small>
            </div>
          </div>
          <div class="rfq-actions">
            <button id="save-rfq-btn" class="btn-secondary">Save Draft</button>
            <button id="publish-rfq-btn" class="btn-primary">Publish Now</button>
          </div>
        </div>
      </div>
      <div id="rfq-status"></div>
    </section>

    <!-- Pricing section removed -->
    </div>
  </main>

  <script>

    // Tab switching
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        if (tabName === "pricing") {
          const params = new URLSearchParams(window.location.search);
          const eventId = params.get("id");
          window.location.href = `auction.html?event_id=${eventId}`;
          return;
        }
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Activate tab from URL parameter (?tab=lots)
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const tabName = params.get("tab");

      if (tabName) {
        // deactivate all tabs and contents
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

        // activate the tab specified in the URL
        const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
        const activeContent = document.getElementById(tabName);

        if (activeTab && activeContent) {
          activeTab.classList.add("active");
          activeContent.classList.add("active");
        }
      }
    });

    // Load event details
    async function loadEvent() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) {
        document.getElementById('event-details').innerHTML = '<p>No event ID provided.</p>';
        return;
      }

      try {
        const res = await authFetch(`/events/${id}`);
        const event = await res.json();

        if (event.error) {
          document.getElementById('event-details').innerHTML = '<p>Event not found.</p>';
          return;
        }

        document.getElementById('event-details').innerHTML = `
  <div class="event-header-section">
    <div>
      <div style="margin-bottom: 8px;">
        <span style="display: inline-block; font-size: 1.125rem; font-weight: 600; color: #2563eb;">${event.organisation_name || 'No Organisation'}</span>
        <span style="display: inline-block; margin: 0 8px; color: #cbd5e1;">â€¢</span>
        <span style="display: inline-block; font-size: 1.125rem; font-weight: 600; color: #64748b;">${event.category_name || 'No Category'}</span>
      </div>
      <h1 class="event-title">${event.title}</h1>
      <p class="event-description">${event.description || ''}</p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 12px; align-items: flex-end;">
      <div style="text-align: right;">
        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Auction Start</div>
        <div style="font-size: 1rem; font-weight: 600; color: #2563eb;">${
    event.auction_time
      ? new Date(event.auction_time).toLocaleString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZoneName: 'short'
        })
      : '-'
  }</div>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Status</div>
        <div style="font-size: 0.9375rem; font-weight: 600; color: ${event.type === 'sealed' ? '#059669' : '#2563eb'};">${event.type === 'sealed' ? 'Sealed' : 'Open'}</div>
      </div>
      <div class="event-actions" style="margin-top: 8px;">
        <button id="edit-btn" class="btn-edit">Edit Event</button>
        <button id="delete-btn" class="btn-delete">Delete Event</button>
      </div>
    </div>
  </div>
  <div class="event-details-grid" style="display: block; margin-top: 24px;">
    <div class="detail-row">
      <span class="detail-label">Currency:</span>
      <span class="detail-value">${event.currency || '-'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Auction Duration:</span>
      <span class="detail-value">${event.auction_duration ? event.auction_duration + ' minutes' : '-'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Extension Time:</span>
      <span class="detail-value">${event.extension_time ? event.extension_time + ' seconds' : '-'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Extension Threshold:</span>
      <span class="detail-value">${event.extension_threshold ? event.extension_threshold + ' seconds' : '-'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Support Contact:</span>
      <span class="detail-value">${event.support_contact || '-'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Bid Manager:</span>
      <span class="detail-value">${event.bid_manager || '-'}</span>
    </div>
  </div>
  <div class="event-meta">Created: ${new Date(event.created_at).toLocaleString()}</div>
`;

        const deleteBtn = document.getElementById('delete-btn');
        const editBtn = document.getElementById('edit-btn');
        editBtn.addEventListener('click', () => {
          window.location.href = `create-event.html?id=${id}`;
        });
        deleteBtn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) return;

          try {
            const delRes = await authFetch(`/events/${id}`, { method: 'DELETE' });
            if (delRes.ok) {
              alert('Event deleted successfully.');
              window.location.href = 'events.html';
            } else {
              const err = await delRes.json().catch(() => ({}));
              alert('Failed to delete event.' + (err.error ? ' ' + err.error : ''));
            }
          } catch (e) {
            alert('Error deleting event: ' + e.message);
          }
        });
      } catch (err) {
        document.getElementById('event-details').innerHTML = '<p>Error loading event details.</p>';
        console.error(err);
      }
    }

    // Load lots for this event
    async function loadLots(eventId) {
      try {
        const res = await authFetch(`/events/${eventId}/lots`);
        const lots = await res.json();
        const list = document.getElementById('lots-list');
        list.innerHTML = '';
        if (lots.length === 0) {
          list.innerHTML = '<p class="loading-text">No lots yet.</p>';
        } else {
          lots.forEach(lot => {
            const div = document.createElement('div');
            div.className = 'lot-card';
            div.innerHTML = `
              <div class="lot-header">
                <div>
                  <h3 class="lot-title" onclick="window.location.href='lot.html?id=${lot.id}'">${lot.title}</h3>
                  <p class="lot-description">${lot.description || ''}</p>
                </div>
                <button onclick="window.location.href='create-lot.html?event_id=${eventId}&lot_id=${lot.id}'" class="btn-edit">Edit</button>
              </div>
            `;
            list.appendChild(div);
          });
        }
      } catch (err) {
        console.error('Error loading lots:', err);
        document.getElementById('lots-list').innerHTML = '<p>Error loading lots.</p>';
      }
    }

    // Load all line items for this event (from all lots), render as one table with grouped headers and horizontal scroll
    async function loadAllLineItems(eventId) {
      try {
        const res = await authFetch(`/events/${eventId}/line-items`);
        const items = await res.json();
        const container = document.getElementById('lines');
        container.innerHTML = '<h2>All Line Items</h2><p>All Line items from all groups will be listed here</p>';

        if (!Array.isArray(items) || items.length === 0) {
          container.innerHTML += '<p>No line items found.</p>';
          return;
        }

        // Table setup
        // Grouped header structure (same as in lot.html):
        // Core Info (7), Bid Settings (6), Evaluative Settings (5), Bid Interface Visibility (3)
        // Column order:
        //   Core Info: Lot, Item Number, Item Name, Group Number, Description, Quantity, UOM
        //   Bid Settings: Input, Required, Ties, Decimals, Decrement, Opening Value
        //   Evaluative Settings: Baseline, Ext Quantity, Ext Baseline, Reserve Value, Incumbent
        //   Bid Interface Visibility: Weighting Visible, Opening Visible, Reserve Visible
        const table = document.createElement('table');
        table.className = 'table table-striped table-bordered';

        const thead = document.createElement('thead');
        // First grouped header row
        const groupHeaderRow = document.createElement('tr');
        [
          { label: 'Core Info', span: 7 },
          { label: 'Bid Settings', span: 6 },
          { label: 'Evaluative Settings', span: 5 },
          { label: 'Bid Interface Visibility', span: 3 }
        ].forEach(group => {
          const th = document.createElement('th');
          th.colSpan = group.span;
          th.style.textAlign = 'center';
          th.textContent = group.label;
          groupHeaderRow.appendChild(th);
        });
        thead.appendChild(groupHeaderRow);
        // Second header row (actual column headers)
        const headerRow = document.createElement('tr');
        const headers = [
          // Core Info (7)
          'Lot',
          'Item Number',
          'Item Name',
          'Group Number',
          'Description',
          'Quantity',
          'UOM',
          // Bid Settings (6)
          'Input',
          'Required',
          'Ties',
          'Decimals',
          'Decrement',
          'Opening Value',
          // Evaluative Settings (5)
          'Baseline',
          'Ext Quantity',
          'Ext Baseline',
          'Reserve Value',
          'Incumbent',
          // Bid Interface Visibility (3)
          'Weighting Visible',
          'Opening Visible',
          'Reserve Visible'
        ];
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        items.forEach(item => {
          const tr = document.createElement('tr');

          // Helper to get display value
          const getValue = (key) => {
            if (typeof item[key] === 'boolean') return item[key] ? 'Yes' : 'No';
            if (item[key] === null || item[key] === undefined || item[key] === '') return '-';
            return item[key];
          };

          const cells = [
            // Core Info (7)
            item.lot_title || item.lot_name || item.lot_id || '-',
            getValue('item_number'),
            getValue('item_name'),
            getValue('group_number'),
            getValue('description'),
            getValue('quantity'),
            getValue('uom'),
            // Bid Settings (6)
            getValue('input'),
            getValue('required'),
            getValue('ties'),
            getValue('decimals'),
            getValue('decrement'),
            getValue('opening_value'),
            // Evaluative Settings (5)
            getValue('baseline'),
            getValue('ext_quantity'),
            getValue('ext_baseline'),
            getValue('reserve_value'),
            getValue('incumbent'),
            // Bid Interface Visibility (3)
            getValue('weighting_visible'),
            getValue('opening_visible'),
            getValue('reserve_visible')
          ];

          cells.forEach(val => {
            const td = document.createElement('td');
            td.textContent = val;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        // Wrap table in horizontally scrollable div
        const scrollDiv = document.createElement('div');
        scrollDiv.style.overflowX = 'auto';
        scrollDiv.appendChild(table);
        container.appendChild(scrollDiv);
      } catch (err) {
        console.error('Error loading line items:', err);
        const container = document.getElementById('lines');
        container.innerHTML = '<h2>All Line Items</h2><p>Error loading line items.</p>';
      }
    }

    // Handle Create New Lot button
    function setupCreateLotButton(eventId) {
      const btn = document.getElementById('create-lot-btn');
      btn.addEventListener('click', () => {
        window.location.href = `create-lot.html?event_id=${eventId}`;
      });
    }

    // Call loadLots and setupCreateLotButton after event is loaded
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (id) {
        await loadEvent();
        await loadLots(id);
        await loadAllLineItems(id);
        setupCreateLotButton(id);
        await loadUsersAndMembers(id);
      }
    }

    // Load users & current members; render separate Managers and Bidders lists (managers simplified, bidders grouped by organisation)
    async function loadUsersAndMembers(eventId) {
      try {
        const [usersRes, eventRes, membersRes] = await Promise.all([
          authFetch("/users"),
          authFetch(`/events/${eventId}`),
          authFetch(`/events/${eventId}/members`)
        ]);

        const users = await usersRes.json();
        const event = await eventRes.json();
        const members = await membersRes.json();

        const assignedBidderIds = new Set(
          members.filter(m => m.role === "bidder").map(m => m.user_id)
        );

        const managerList = document.getElementById("managerList");
        managerList.innerHTML = "";
        const managers = users.filter(u => u.role === "manager");
        managers.sort((a, b) => (a.id === event.created_by ? -1 : b.id === event.created_by ? 1 : 0));

        const assignedManagerIds = new Set(
          members.filter(m => m.role === "creator" || m.role === "participant").map(m => m.user_id)
        );

        managers.forEach(u => {
          const isCreator = u.id === event.created_by;
          const checked = assignedManagerIds.has(u.id) || isCreator;
          const row = document.createElement("div");
          row.className = "member-item";
          row.innerHTML = `
            <div class="member-info">
              <strong>${(u.first_name || "")} ${(u.last_name || "")}${isCreator ? " (Creator)" : ""}</strong>
            </div>
            <input type="checkbox" class="manager-assign member-checkbox" data-user-id="${u.id}" ${checked ? "checked" : ""} ${isCreator ? "disabled" : ""}/>
          `;
          managerList.appendChild(row);
        });

        window._currentAssignedManagerIds = assignedManagerIds;

        const bidderList = document.getElementById("bidderList");
        bidderList.innerHTML = "";
        const bidders = users.filter(u => u.role === "bidder");
        bidders.sort((a, b) => (a.first_name || "").localeCompare(b.first_name || ""));

        // Render bidders as flat list, showing supplier organisation name as primary label
        bidders.forEach(u => {
          const checked = assignedBidderIds.has(u.id);
          const row = document.createElement("div");
          row.className = "bidder-card";
          row.innerHTML = `
            <div class="bidder-header">
              <div class="bidder-org-wrapper">
                <a href="assign-line-items.html?event_id=${eventId}&user_id=${u.id}" class="bidder-org">
                  ${u.organisation_name || "Unassigned Organisation"}
                </a>
              </div>
              <div class="checkbox-wrapper">
                <input type="checkbox" class="bidder-assign member-checkbox" data-user-id="${u.id}" ${checked ? "checked" : ""} />
              </div>
            </div>
            <div class="bidder-info">
              <small>${(u.first_name || "")} ${(u.last_name || "")} â€” ${u.email || ""}</small>
            </div>
          `;
          bidderList.appendChild(row);
        });

        window._currentAssignedBidderIds = assignedBidderIds;
      } catch (err) {
        console.error("Error loading users/members:", err);
        const managerList = document.getElementById("managerList");
        const bidderList = document.getElementById("bidderList");
        if (managerList) managerList.innerHTML = "<p>Error loading managers.</p>";
        if (bidderList) bidderList.innerHTML = "<p>Error loading bidders.</p>";
      }
    }

    // Save member assignments: managers and bidders
    document.getElementById("save-members-btn").addEventListener("click", async () => {
      const params = new URLSearchParams(window.location.search);
      const eventId = params.get('id');
      if (!eventId) return;

      const checkedBidders = Array.from(document.querySelectorAll(".bidder-assign:checked"))
        .map(cb => parseInt(cb.dataset.userId, 10));
      
      const checkedManagers = Array.from(document.querySelectorAll(".manager-assign:checked"))
        .map(cb => parseInt(cb.dataset.userId, 10));

      try {
        await authFetch(`/events/${eventId}/members`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            managers: checkedManagers, 
            bidders: checkedBidders 
          })
        });

        alert("Member assignments saved successfully.");
        await loadUsersAndMembers(eventId);
      } catch (e) {
        console.error("Error saving assignments:", e);
        alert("Failed to save assignments.");
      }
    });

    init();
  </script>
  <footer>
    <p>Tendersmith Â© 2025</p>
  </footer>
  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Enable messaging script -->
  <script src="/messages.js"></script>
  <!-- Bootstrap JS (for optional interactivity) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>