<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bidder Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script src="/auth.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="bidder.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="bidder.html">My Auctions</a></li>
        <li><a href="bidderaccount.html">Account</a></li>
        <li><a href="#" id="logout">Logout</a></li>
      </ul>
    </div>
  </nav>

  <main class="container mt-4">
    <h1>Welcome to Your Auctions</h1>
    <p>Below are the events you’ve been invited to bid on.</p>

    <section id="events-section" class="mt-4">
      <h3>Your Events</h3>
      <div id="bidder-events-list" class="list-group"></div>
    </section>

    <section id="upcoming-auction" class="mt-5">
      <h3>Next Auction</h3>
      <div id="next-auction" class="card p-3">
        <p>Loading your next auction...</p>
      </div>
    </section>
  </main>

  <footer class="text-center mt-5">
    <p>Tendersmith © 2025</p>
  </footer>

  <script>
    async function loadBidderEvents() {
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "start.html";
        return;
      }

      try {
        // Decode user info from token
        const payload = JSON.parse(atob(token.split('.')[1]));
        const userId = payload.id;

        const res = await authFetch(`http://localhost:4000/bidders/${userId}/events`);
        const events = await res.json();

        const list = document.getElementById("bidder-events-list");
        const nextAuctionDiv = document.getElementById("next-auction");

        if (!events.length) {
          list.innerHTML = "<p>You are not invited to any events yet.</p>";
          nextAuctionDiv.innerHTML = "<p>No upcoming auctions.</p>";
          return;
        }

        // Sort by soonest auction
        events.sort((a, b) => new Date(a.auction_time) - new Date(b.auction_time));

        // List all events
        list.innerHTML = "";
        events.forEach(evt => {
          const div = document.createElement("div");
          div.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center");
          div.innerHTML = `
            <div>
              <h5>${evt.title}</h5>
              <small>${evt.organisation_name || "-"} • ${new Date(evt.auction_time).toLocaleString()}</small>
            </div>
            <button class="btn btn-primary btn-sm" onclick="window.location.href='bid-screen.html?event_id=${evt.id}'">Enter</button>
          `;
          list.appendChild(div);
        });

        // Highlight the soonest event
        const next = events[0];
        nextAuctionDiv.innerHTML = `
          <h5>${next.title}</h5>
          <p>${next.organisation_name || "-"} • ${new Date(next.auction_time).toLocaleString()}</p>
          <button class="btn btn-success" onclick="window.location.href='bid-screen.html?event_id=${next.id}'">Join Auction</button>
        `;
      } catch (err) {
        console.error("Error loading bidder events:", err);
        document.getElementById("bidder-events-list").innerHTML = "<p>Error loading your events.</p>";
      }
    }

    loadBidderEvents();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>