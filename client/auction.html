<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Auction Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script>
    // Restrict page to managers (auth.js respects this)
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
  <style>
    body { background: #f7f7f7; }
    .page-wrap { max-width: 1200px; margin: 20px auto; }
    .topbar { display:flex; justify-content: space-between; align-items:center; gap:12px; }
    .pill { padding:4px 10px; border-radius: 999px; background:#eee; font-weight:600; }
    .summary { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px; }
    .summary .card { text-align:center; }
    .grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; margin-top:16px; }
    .bid-stream { height: 420px; overflow:auto; background:white; border-radius:8px; border:1px solid #e5e5e5; padding:10px; }
    .bid-entry { display:grid; grid-template-columns: 105px 1fr 80px 110px; gap:8px; padding:8px 6px; border-bottom:1px solid #f0f0f0; font-size: 14px; }
    .bid-entry.lowest { background:#f3fff3; }
    .rank-table td, .rank-table th { vertical-align: middle; }
    .badge-newlow { font-size: 11px; background:#e8f7e8; color:#1c7c1c; border:1px solid #bfe3bf; }
    .controls { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">üí¨</button></li>
      </ul>
    </div>
  </nav>

  <div class="page-wrap">
    <!-- Topbar / Overview -->
    <div class="card p-3 mb-3">
      <div class="topbar">
        <div>
          <h3 id="auction-title" class="mb-0">Live Auction</h3>
          <small id="auction-sub" class="text-muted">Loading event...</small>
        </div>
        <div class="controls">
          <span class="pill" id="auction-status">Loading‚Ä¶</span>
          <span class="pill">Currency: <span id="currency-pill">‚Äî</span></span>
          <span class="pill">‚è± <span id="countdown">--:--:--</span></span>
          <button id="pause-resume-btn" class="btn btn-warning">Pause Auction</button>
          <a id="back-to-event" class="btn btn-outline-secondary" href="#">Back to Event</a>
        </div>
      </div>
      <div class="summary">
        <div class="card"><div class="card-body"><div class="fw-bold">Total Bids</div><div id="total-bids" class="fs-4">0</div></div></div>
        <div class="card"><div class="card-body"><div class="fw-bold">Extensions</div><div id="extensions-count" class="fs-4">0</div></div></div>
        <div class="card"><div class="card-body"><div class="fw-bold">Bidders Connected</div><div id="bidders-connected" class="fs-5">0 / 0</div></div></div>
      </div>
    </div>

    <div class="grid">
      <!-- Ranked table -->
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Ranked Bidders</h5>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggle-weighted">
              <label class="form-check-label" for="toggle-weighted">Show weighted bids</label>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered rank-table">
              <thead>
                <tr>
                  <th style="width:60px;">Rank</th>
                  <th>Bidder</th>
                  <th id="th-bid">Bid</th>
                  <th>Savings %</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="ranked-body">
                <tr><td colspan="5" class="text-center text-muted">No bids yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bid stream -->
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Live Bid Stream</h5>
            <small class="text-muted" id="last-updated">Last updated: ‚Äî</small>
          </div>
          <div id="bid-stream" class="bid-stream">
            <p class="text-muted mb-0">Waiting for bids‚Ä¶</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional chart block (left as placeholder; can wire to Chart.js later) -->
    <!-- <div class="card mt-3"><div class="card-body"><h5>Bid Trends</h5><canvas id="bid-chart"></canvas></div></div> -->
  </div>

  <footer class="mt-4"><p class="text-center text-muted">Tendersmith ¬© 2025</p></footer>

  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Messaging script (keeps chat icon working) -->
  <script src="/messages.js"></script>

  <script>
    // --- Utilities ---
    const currencySymbols = { GBP:'¬£', USD:'$', EUR:'‚Ç¨', CAD:'$', AUD:'$', NZD:'$', CHF:'CHF', JPY:'¬•', CNY:'¬•', INR:'‚Çπ', SEK:'kr', NOK:'kr', DKK:'kr', PLN:'z≈Ç', ZAR:'R' };

    function fmtMoney(n, symbol){
      try { return `${symbol}${Number(n).toLocaleString()}`; } catch { return `${symbol}${n}`; }
    }

    function pad(n){ return String(n).padStart(2,'0'); }

    function formatHMS(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const hh = pad(Math.floor(s/3600));
      const mm = pad(Math.floor((s%3600)/60));
      const ss = pad(s%60);
      return `${hh}:${mm}:${ss}`;
    }

    // --- Page state ---
    let eventId; // from query
    let eventData = null;
    let currencySymbol = '¬£';
    let showWeighted = false;
    let countdownTimer = null;

    // --- Load event and basic stats ---
    async function loadEvent(){
      const res = await authFetch(`/events/${eventId}`);
      eventData = await res.json();
      const code = (eventData.currency || 'GBP').toUpperCase();
      currencySymbol = currencySymbols[code] || code || '¬£';
      document.getElementById('currency-pill').textContent = currencySymbol;
      document.getElementById('auction-title').textContent = eventData.title || 'Live Auction';
      document.getElementById('auction-sub').textContent = eventData.description || '';
      // Back to event link
      const back = document.getElementById('back-to-event');
      back.href = `event.html?id=${eventId}&tab=pricing`;

      // Start/End times & status
      let status = 'Scheduled';
      if (eventData.auction_time){
        const start = new Date(eventData.auction_time);
        const now = new Date();
        status = now >= start ? 'Live' : 'Scheduled';
        const durationMin = Number(eventData.auction_duration || 60);
        const end = new Date(start.getTime() + durationMin*60*1000);
        startCountdown(end);
      }
      document.getElementById('auction-status').textContent = status;
    }

    function startCountdown(end){
      clearInterval(countdownTimer);
      countdownTimer = setInterval(()=>{
        const diff = end - new Date();
        document.getElementById('countdown').textContent = formatHMS(diff);
        if (diff <= 0) clearInterval(countdownTimer);
      }, 1000);
    }

    async function loadStats(){
      try {
        const res = await authFetch(`/events/${eventId}/stats`);
        const s = await res.json();
        document.getElementById('total-bids').textContent = s.total_bids || 0;
        document.getElementById('extensions-count').textContent = s.extensions || 0;
        document.getElementById('bidders-connected').textContent = `${s.bidders_connected || 0} / ${s.total_bidders || 0}`;
        if (s.auction_time && eventData && eventData.auction_time){ /* already handled */ }
      } catch(e){ console.error('Stats error', e); }
    }

    // Keep a rolling store of bids (latest first)
    let allBids = [];

    async function loadBids(){
      try {
        const res = await authFetch(`/events/${eventId}/bids`);
        const bids = await res.json();
        allBids = bids || [];
        renderBids();
      } catch(e){ console.error('Bids error', e); }
    }

    function computeBidValue(b){
      // Prefer server-provided effective_amount/weighting if present
      const weighting = (typeof b.weighting === 'number' ? b.weighting : null);
      const effective = (typeof b.effective_amount === 'number' ? b.effective_amount : null);
      if (showWeighted){
        if (effective != null) return effective;
        if (weighting != null) return b.amount * weighting;
      }
      return b.amount;
    }

    function renderBids(){
      const tbody = document.getElementById('ranked-body');
      const stream = document.getElementById('bid-stream');
      const nowStr = new Date().toLocaleTimeString();
      document.getElementById('last-updated').textContent = `Last updated: ${nowStr}`;

      if (!allBids.length){
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No bids yet</td></tr>';
        stream.innerHTML = '<p class="text-muted mb-0">Waiting for bids‚Ä¶</p>';
        return;
      }

      // Latest bid per bidder (lowest wins)
      const latestByUser = {};
      for (const b of allBids){
        const key = b.user_id;
        if (!latestByUser[key] || new Date(b.created_at) > new Date(latestByUser[key].created_at)){
          latestByUser[key] = b;
        }
      }
      const rows = Object.values(latestByUser).map(b => ({...b, value: computeBidValue(b)}));
      rows.sort((a,b) => a.value - b.value);

      const best = rows[0].value;
      tbody.innerHTML = rows.map((b, i) => {
        const savings = best > 0 ? (((best - b.value)/best)*100).toFixed(2) : '0.00';
        return `
          <tr class="${i===0? 'table-success':''}">
            <td>${i+1}</td>
            <td>${b.user_name || ('Bidder '+b.user_id)}</td>
            <td>${fmtMoney(b.value, currencySymbol)}</td>
            <td>${savings}%</td>
            <td>${new Date(b.created_at).toLocaleTimeString()}</td>
          </tr>`;
      }).join('');

      // Bid stream (newest first)
      const streamHtml = [...allBids]
        .sort((a,b)=> new Date(b.created_at) - new Date(a.created_at))
        .map((b,i)=>{
          const val = computeBidValue(b);
          const isLowest = val === best;
          return `
            <div class="bid-entry ${isLowest? 'lowest':''}">
              <span class="text-muted">${new Date(b.created_at).toLocaleTimeString()}</span>
              <span><strong>${b.user_name || ('Bidder '+b.user_id)}</strong></span>
              <span class="text-nowrap">#${b.line_item_id || '-'}</span>
              <span class="text-end">${fmtMoney(val, currencySymbol)} ${isLowest? '<span class="badge badge-newlow ms-1">new low</span>':''}</span>
            </div>`;
        }).join('');
      stream.innerHTML = streamHtml;

      // Update header based on toggle
      document.getElementById('th-bid').textContent = showWeighted ? `Weighted Bid` : `Bid`;
    }

    function connectSocket(){
      const sock = io(window.location.origin, { transports: ["websocket"] });
      sock.emit('join_event', eventId);

      sock.on('bid_update', (bid)=>{
        // Push and re-render; rely on server payload shape
        allBids.push(bid);
        renderBids();
        loadStats();
      });

      sock.on('bidders_count_update', loadStats);
      sock.on('auction_paused', ()=>{
        document.getElementById('auction-status').textContent = 'Paused';
        alert('‚è∏Ô∏è Auction paused.');
      });
      sock.on('auction_resumed', ()=>{
        document.getElementById('auction-status').textContent = 'Live';
        alert('‚ñ∂Ô∏è Auction resumed.');
      });
    }

    async function togglePauseResume(){
      const btn = document.getElementById('pause-resume-btn');
      const isPause = btn.textContent.toLowerCase().includes('pause');
      try{
        const res = await authFetch(`/events/${eventId}/${isPause? 'pause':'resume'}`, { method:'PATCH' });
        if (res.ok){
          btn.textContent = isPause? 'Resume Auction' : 'Pause Auction';
          document.getElementById('auction-status').textContent = isPause? 'Paused':'Live';
        }
      }catch(e){ console.error(e); }
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async ()=>{
      const params = new URLSearchParams(window.location.search);
      eventId = params.get('event_id');
      if (!eventId){
        alert('Missing event_id');
        window.location.href = 'events.html';
        return;
      }

      document.getElementById('toggle-weighted').addEventListener('change', (e)=>{
        showWeighted = e.target.checked;
        renderBids();
      });
      document.getElementById('pause-resume-btn').addEventListener('click', togglePauseResume);

      await loadEvent();
      await loadStats();
      await loadBids();
      connectSocket();
    });
  </script>
</body>
</html>