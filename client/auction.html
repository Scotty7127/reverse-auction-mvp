<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Auction Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/eventdetail.css" />
  <link rel="stylesheet" href="css/auction.css" />
  <script>
    // Restrict page to managers (auth.js respects this)
    window.requiredRoles = ["manager"];
  </script>
  <script src="/config.js"></script>
  <script src="/auth.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="manager.html" class="brand">Tendersmith</a>
      <ul class="nav-links">
        <li><a href="manager.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="organisations.html">Organisations</a></li>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="messages-btn" class="nav-icon-btn">üí¨</button></li>
      </ul>
    </div>
  </nav>

  <div class="event-tabs">
    <div class="tab" data-tab="overview">Overview</div>
    <div class="tab" data-tab="lots">Lots</div>
    <div class="tab" data-tab="lines">All Line Items</div>
    <div class="tab" data-tab="members">Members</div>
    <div class="tab" data-tab="docs">Documents</div>
    <div class="tab" data-tab="responses">Responses</div>
    <div class="tab active" data-tab="pricing">Pricing</div>
  </div>

  <div class="auction-container">
    <!-- Auction Header -->
    <div class="auction-header">
      <div class="auction-title-section">
        <h1 id="auction-title">Live Auction</h1>
      </div>
      <div class="auction-timer-section">
        <div id="time-main" class="timer-display">Loading...</div>
        <div id="time-sub" class="timer-subtitle"></div>
      </div>
      <div class="auction-controls-section">
        <button id="pause-resume-btn" class="btn-control" disabled style="min-width: 100px; font-weight: 600;">PAUSE</button>
        <button id="debug-start-now-btn" class="btn-control" style="margin-left: 8px; background: #f59e0b; border-color: #f59e0b;">üöÄ DEBUG: Start Now</button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-label">Total Bids</span>
        <span class="stat-value" id="total-bids-value">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Bidders Connected</span>
        <span class="stat-value" id="bidders-connected-value">0 / 0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Extensions</span>
        <span class="stat-value" id="extensions-value">0</span>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-container">
      <h2>Total Savings</h2>
      <canvas id="bid-chart"></canvas>
    </div>

    <!-- Tables Grid -->
    <div class="tables-grid">
      <!-- Ranked Bidders -->
      <div class="table-section">
        <h2>Ranked Bidders</h2>
        <div class="table-scroll">
          <table class="auction-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Bidder</th>
                <th>Total Savings</th>
                <th>Savings %</th>
              </tr>
            </thead>
            <tbody id="ranked-body">
              <tr><td colspan="4" class="empty-state">No bids yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Bid Stream -->
      <div class="table-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h2 style="margin: 0;">Bid Stream</h2>
          <div>
            <button id="edit-bid-btn" class="btn btn-sm btn-outline-primary" style="margin-right: 8px;" disabled>Edit Selected</button>
            <button id="delete-bid-btn" class="btn btn-sm btn-outline-danger" disabled>Delete Selected</button>
          </div>
        </div>
        <div class="table-scroll">
          <table class="auction-table">
            <thead>
              <tr>
                <th>Bid ID</th>
                <th>Time</th>
                <th>Bidder</th>
                <th>Line Item #</th>
                <th>Line Item Name</th>
                <th>Bid Amount</th>
              </tr>
            </thead>
            <tbody id="bid-stream-body">
              <tr><td colspan="6" class="empty-state">No bids yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <script src="/auction-graphs.js"></script>
  <script src="/messages.js"></script>

  <script>
    // --- Utilities ---
    const currencySymbols = { GBP:'¬£', USD:'$', EUR:'‚Ç¨', CAD:'$', AUD:'$', NZD:'$', CHF:'CHF', JPY:'¬•', CNY:'¬•', INR:'‚Çπ', SEK:'kr', NOK:'kr', DKK:'kr', PLN:'z≈Ç', ZAR:'R' };
    function fmtMoney(n, symbol){
      try { return `${symbol}${Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; } catch { return `${symbol}${n}`; }
    }
    function pad(n){ return String(n).padStart(2,'0'); }
    function formatHMS(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const hh = pad(Math.floor(s/3600));
      const mm = pad(Math.floor((s%3600)/60));
      const ss = pad(s%60);
      return `${hh}:${mm}:${ss}`;
    }
    function formatHM(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const hh = Math.floor(s/3600);
      const mm = Math.floor((s%3600)/60);
      if(hh > 0) return `${hh}h ${mm}m`;
      return `${mm}m`;
    }
    function formatStartsIn(ms){
      if(ms <= 0) return "Starts now";
      const s = Math.floor(ms/1000);
      const days = Math.floor(s / 86400);
      const hours = Math.floor((s % 86400) / 3600);
      const minutes = Math.floor((s % 3600) / 60);
      if(days > 0) return `Starts in ${days} day${days > 1 ? 's' : ''}`;
      if(hours > 0) return `Starts in ${hours} hour${hours > 1 ? 's' : ''}`;
      if(minutes > 0) return `Starts in ${minutes} minute${minutes > 1 ? 's' : ''}`;
      return "Starting soon";
    }
    function getRandomColor(seed) {
      // Generate a consistent pastel color based on seed string
      let hash = 0;
      for(let i=0; i<seed.length; i++) {
        hash = seed.charCodeAt(i) + ((hash << 5) - hash);
      }
      const h = hash % 360;
      return `hsl(${h}, 70%, 60%)`;
    }

    // --- Page state ---
    let eventId = null;
    let eventData = null;
    let currencySymbol = '¬£';
    let auctionStart = null;
    let auctionDurationMs = 0;
    let auctionEnd = null;
    let auctionLive = false;
    let auctionPaused = false;
    let pausedTimeRemaining = null; // Store time remaining when paused
    let countdownInterval = null;
    // Chart.js chart handled by AuctionGraphs module

    // Data stores
    let allBids = []; // all bids loaded or received live
    let openingBids = []; // injected opening bids from supplier assignments
    let biddersMap = new Map(); // bidderId -> { user_name, bids: [{time, weightedBid, savings}] }
    let baselineMap = new Map(); // line_item_id -> { ext_baseline, ext_quantity, item_number, item_name }

    // --- DOM elements ---
    const auctionTitleEl = document.getElementById('auction-title');
    const timeMainEl = document.getElementById('time-main');
    const timeSubEl = document.getElementById('time-sub');
    const pauseResumeBtn = document.getElementById('pause-resume-btn');
    const rankedBody = document.getElementById('ranked-body');

    // Chart config handled by AuctionGraphs module

    // Track last total baseline for chart reinit
    let lastTotalBaseline = null;

    // --- Helper function to update pause/resume button ---
    function setPauseButtonState(isPaused) {
      if (isPaused) {
        pauseResumeBtn.textContent = 'RESUME';
        pauseResumeBtn.style.background = '#22c55e';
        pauseResumeBtn.style.borderColor = '#22c55e';
        pauseResumeBtn.style.color = '#ffffff';
      } else {
        pauseResumeBtn.textContent = 'PAUSE';
        pauseResumeBtn.style.background = '#ef4444';
        pauseResumeBtn.style.borderColor = '#ef4444';
        pauseResumeBtn.style.color = '#ffffff';
      }
    }

    // --- Auction time management ---
    function updateCountdown(){
      if(!auctionStart) return;
      
      const now = new Date();
      if(!auctionLive){
        const msUntilStart = auctionStart - now;
        if(msUntilStart > 0){
          timeMainEl.textContent = formatStartsIn(msUntilStart);
          timeSubEl.textContent = `Starts at ${auctionStart.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
          pauseResumeBtn.disabled = true;
          setPauseButtonState(false);
          auctionPaused = false;
        } else {
          // Auction just started
          auctionLive = true;
          pauseResumeBtn.disabled = false;
          setPauseButtonState(false);
          auctionEnd = new Date(auctionStart.getTime() + auctionDurationMs);
          timeSubEl.textContent = '';
          // Start the x-axis expansion now that auction is live, passing actual start time
          AuctionGraphs.startXAxisExpansion(auctionStart);
        }
      }
      if(auctionLive){
        // If paused, display the frozen time
        if(auctionPaused && pausedTimeRemaining !== null){
          timeMainEl.textContent = `‚è∏Ô∏è ${formatHMS(pausedTimeRemaining)}`;
          timeSubEl.textContent = 'Paused';
          return;
        }
        
        const msLeft = auctionEnd - now;
        if(msLeft <= 0){
          timeMainEl.textContent = 'Auction ended';
          timeSubEl.textContent = '';
          pauseResumeBtn.disabled = true;
          auctionLive = false;
          auctionPaused = true;
          setPauseButtonState(false);
          clearInterval(countdownInterval);
          // Stop x-axis expansion when auction ends
          AuctionGraphs.stopXAxisExpansion();
          return;
        }
        timeMainEl.textContent = `Time left: ${formatHMS(msLeft)}`;
        timeSubEl.textContent = '';
      }
    }

    // --- Bid savings computation ---
    // savings = (lineItem.ext_baseline - (bid.amount * bid.weighting * lineItem.ext_quantity))
    function computeBidSavings(bid){
      if(!bid.line_item_id) return 0;
      const baselineObj = baselineMap.get(bid.line_item_id);
      if(!baselineObj) return 0;
      const extBaseline = baselineObj.ext_baseline || 0;
      const extQuantity = baselineObj.ext_quantity || 1;
      const weighting = (typeof bid.weighting === 'number') ? bid.weighting : 1;
      const weightedBid = bid.amount * weighting * extQuantity;
      return extBaseline - weightedBid;
    }
    function computeWeightedBid(bid){
      const weighting = (typeof bid.weighting === 'number') ? bid.weighting : 1;
      return bid.amount * weighting;
    }

    // --- Load event and baseline data ---
    async function loadEvent(){
      const res = await authFetch(`/events/${eventId}`);
      eventData = await res.json();
      auctionTitleEl.textContent = eventData.title || 'Live Auction';

      const code = (eventData.currency || 'GBP').toUpperCase();
      currencySymbol = currencySymbols[code] || code || '¬£';

      if(eventData.auction_time){
        auctionStart = new Date(eventData.auction_time);
      }
      auctionDurationMs = (Number(eventData.auction_duration) || 60) * 60 * 1000;
      auctionLive = false;
      auctionPaused = true;
      pauseResumeBtn.disabled = true;
      setPauseButtonState(false);

      // Load baseline data for line items (if available)
      baselineMap.clear();
      if(Array.isArray(eventData.line_items)){
        for(const li of eventData.line_items){
          if(li.id){
            baselineMap.set(li.id, {
              ext_baseline: Number(li.ext_baseline) || 0,
              ext_quantity: Number(li.ext_quantity) || 1,
              item_number: li.item_number,
              item_name: li.item_name
            });
          }
        }
      }

      // Inject opening bids for suppliers before auction begins, if present
      // This allows pre-assigned opening prices to display as first bids
      const supplierAssignments = eventData.supplier_assignments || eventData.assigned_suppliers;
      if (Array.isArray(supplierAssignments)) {
        for (const sa of supplierAssignments) {
          if (sa.opening_bid !== undefined && sa.opening_bid !== null) {
            openingBids.push({
              id: `opening-${sa.supplier_id}-${sa.line_item_id}`,
              user_id: sa.supplier_id,
              user_name: sa.supplier_name || `Supplier ${sa.supplier_id}`,
              line_item_id: sa.line_item_id,
              amount: Number(sa.opening_bid) || 0,
              weighting: Number(sa.weighting) || 1,
              created_at: eventData.auction_time || new Date().toISOString()
            });
          }
        }
        processBids();
        updateChartAndTable();
      }
    }

    // --- Load stats ---
    async function loadStats(){
      try {
        const res = await authFetch(`/events/${eventId}/stats`);
        const s = await res.json();
        document.getElementById('total-bids-value').textContent = s.total_bids || 0;
        document.getElementById('bidders-connected-value').textContent = `${s.bidders_connected || 0} / ${s.total_bidders || 0}`;
        document.getElementById('extensions-value').textContent = s.extensions || 0;
      } catch(e) {
        console.error('Stats error', e);
      }
    }

    // --- Load bids ---
    async function loadBids(){
      try {
        const res = await authFetch(`/events/${eventId}/bids`);
        const bids = await res.json();
        console.log('Loaded bids:', bids);
        console.log('Sample bid structure:', bids[0]);
        allBids = (bids || []);
        // Prepend opening bids if they exist and aren't already present
        const existingIds = new Set(allBids.map(b => String(b.id)));
        openingBids.forEach(ob => {
          if (!existingIds.has(String(ob.id))) allBids.unshift(ob);
        });
        processBids();
        updateChartAndTable();
      } catch(e) {
        console.error('Bids error', e);
      }
    }

    // --- Process bids for chart and ranking ---
    // Organize bids by bidder with time elapsed and savings
    function processBids(){
      biddersMap.clear();

      // Sort bids by created_at ascending for time series
      allBids.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));

      for(const bid of allBids){
        if(!bid.user_id) continue;
        if(!auctionStart) continue;
        const bidderId = bid.user_id;
        const bidderName = bid.user_name || `Bidder ${bidderId}`;
        
        console.log(`Processing bid ${bid.id}: user_id=${bidderId}, user_name="${bid.user_name}", organisation_name="${bid.organisation_name}"`);

        // Calculate time elapsed in minutes from auctionStart
        const createdAt = new Date(bid.created_at);
        const elapsedMs = createdAt - auctionStart;
        // Allow opening bids even if before auction start
        if (elapsedMs < 0 && !(bid.id && bid.id.startsWith('opening-'))) continue;

        const elapsedMinutes = elapsedMs / 60000;

        // Compute extendedBid: amount * weighting * ext_quantity
        const weighting = (typeof bid.weighting === 'number') ? bid.weighting : 1;
        const extQuantity = baselineMap.get(bid.line_item_id)?.ext_quantity || 1;
        const extendedBid = bid.amount * weighting * extQuantity;
        const savings = computeBidSavings(bid);

        if(!biddersMap.has(bidderId)){
          biddersMap.set(bidderId, {
            user_name: bidderName,
            bids: []
          });
        }
        biddersMap.get(bidderId).bids.push({
          time: elapsedMinutes,
          extendedBid,
          savings,
          line_item_id: bid.line_item_id,
          rawBid: bid
        });
      }
    }

    // --- Update Chart and Ranked Table ---
    function updateChartAndTable(){
      // Compute total baseline for all line items (sum of ext_baseline only)
      const totalBaseline = Array.from(baselineMap.values()).reduce((acc, li) => acc + (li.ext_baseline || 0), 0);

      // Only reinitialize chart if the baseline has changed
      if (lastTotalBaseline === null || totalBaseline !== lastTotalBaseline) {
        lastTotalBaseline = totalBaseline;
        console.log('Baseline changed, reinitializing chart:', totalBaseline);
        AuctionGraphs.initChart('bid-chart', totalBaseline, currencySymbol);
      }
      AuctionGraphs.showSavingsByBidder(biddersMap, currencySymbol, totalBaseline);

      // Compute rankings
      const ranking = [];
      biddersMap.forEach((bidder, bidderId) => {
        // Sum total savings and total weighted bid for last bid
        const totalSavings = bidder.bids.reduce((acc, b) => acc + b.savings, 0);
        const lastWeightedBid = bidder.bids.length ? bidder.bids[bidder.bids.length - 1].weightedBid : 0;
        const savingsPercent = totalBaseline > 0 ? (totalSavings / totalBaseline) * 100 : 0;
        ranking.push({
          user_id: bidderId,
          user_name: bidder.user_name,
          totalSavings,
          savingsPercent
        });
      });
      ranking.sort((a,b) => b.totalSavings - a.totalSavings);

      // Render ranked table
      if(ranking.length === 0){
        rankedBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No bids yet</td></tr>';
      } else {
        rankedBody.innerHTML = ranking.map((r,i) => {
          return `<tr>
            <td>${i+1}</td>
            <td>${r.user_name}</td>
            <td>${fmtMoney(r.totalSavings, currencySymbol)}</td>
            <td>${r.savingsPercent.toFixed(2)}%</td>
          </tr>`;
        }).join('');
      }
      updateBidStream();
    }

    // --- Bid Stream Table update ---
    let selectedBidId = null;
    
    function updateBidStream() {
      const tbody = document.getElementById('bid-stream-body');
      if(!tbody) return;
      if(allBids.length === 0){
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No bids yet</td></tr>';
        return;
      }
      allBids.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
      tbody.innerHTML = allBids.map(b=>{
        const li = baselineMap.get(b.line_item_id);
        const lineNum = li?.item_number || b.line_item_id || '-';
        const lineName = li?.item_name || '-';
        const timeInAuction = auctionStart ? ((new Date(b.created_at) - auctionStart)/60000).toFixed(1) + 'm' : '-';
        const bidAmount = fmtMoney(b.amount || 0, currencySymbol);
        const isOpeningBid = String(b.id).startsWith('opening-');
        return `<tr class="bid-row ${isOpeningBid ? 'opening-bid' : 'selectable-bid'}" data-bid-id="${b.id}" data-bid-amount="${b.amount}" data-is-opening="${isOpeningBid}">
          <td>${b.id}</td>
          <td>${timeInAuction}</td>
          <td>${b.user_name || 'Unknown'}</td>
          <td>${lineNum}</td>
          <td>${lineName}</td>
          <td>${bidAmount}</td>
        </tr>`;
      }).join('');
      
      // Add click handlers to rows
      const selectableRows = tbody.querySelectorAll('.selectable-bid');
      console.log(`Found ${selectableRows.length} selectable bid rows`);
      selectableRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => {
          console.log('Row clicked:', row.dataset.bidId);
          selectBidRow(row);
        });
      });
    }
    
    function selectBidRow(row) {
      console.log('selectBidRow called for:', row.dataset.bidId);
      // Remove previous selection
      document.querySelectorAll('.bid-row.selected').forEach(r => r.classList.remove('selected'));
      
      // Select this row
      row.classList.add('selected');
      selectedBidId = row.dataset.bidId;
      
      // Enable buttons
      document.getElementById('edit-bid-btn').disabled = false;
      document.getElementById('delete-bid-btn').disabled = false;
    }
    
    // --- Edit Selected Bid ---
    async function editSelectedBid() {
      console.log('editSelectedBid called, selectedBidId:', selectedBidId);
      if (!selectedBidId) return;
      
      const row = document.querySelector(`.bid-row[data-bid-id="${selectedBidId}"]`);
      if (!row) return;
      
      const currentAmount = row.dataset.bidAmount;
      const newAmount = prompt(`Edit bid amount (current: ${currencySymbol}${currentAmount}):`, currentAmount);
      if (newAmount === null || newAmount === '') return;
      
      const amount = parseFloat(newAmount);
      if (isNaN(amount) || amount <= 0) {
        console.error('Invalid bid amount entered');
        return;
      }

      try {
        const res = await authFetch(`/events/${eventId}/bids/${selectedBidId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        });

        if (res.ok) {
          console.log('Bid updated successfully');
          selectedBidId = null;
          document.getElementById('edit-bid-btn').disabled = true;
          document.getElementById('delete-bid-btn').disabled = true;
          await loadBids();
          loadStats();
        } else {
          const error = await res.json();
          console.error('Failed to update bid:', error.error || 'Unknown error');
        }
      } catch (e) {
        console.error('Error updating bid:', e);
      }
    }

    // --- Delete Selected Bid ---
    async function deleteSelectedBid() {
      console.log('deleteSelectedBid called, selectedBidId:', selectedBidId);
      if (!selectedBidId) return;
      
      if (!confirm('Are you sure you want to delete this bid?')) return;

      try {
        const res = await authFetch(`/events/${eventId}/bids/${selectedBidId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          console.log('Bid deleted successfully');
          selectedBidId = null;
          document.getElementById('edit-bid-btn').disabled = true;
          document.getElementById('delete-bid-btn').disabled = true;
          await loadBids();
          loadStats();
        } else {
          const error = await res.json();
          console.error('Failed to delete bid:', error.error || 'Unknown error');
        }
      } catch (e) {
        console.error('Error deleting bid:', e);
      }
    }

    // --- Socket.IO integration ---
    let socket = null;
    function connectSocket(){
      const token = localStorage.getItem('token');
      socket = io(window.location.origin, {
        transports: ["websocket"],
        auth: { token },
        query: { event_id: eventId }
      });
      socket.emit('join_event', eventId);

      socket.on('bid_update', (bid) => {
        if(!bid.user_id) return;
        allBids.push(bid);
        processBids();
        updateChartAndTable();
        loadStats();
      });

      socket.on('bid_updated', async (data) => {
        console.log('Bid updated:', data);
        // Reload all bids and stats to reflect the change
        await loadBids();
        loadStats();
      });

      socket.on('bid_deleted', async (data) => {
        console.log('Bid deleted:', data);
        // Clear selection if the deleted bid was selected
        if (selectedBidId === String(data.bidId)) {
          selectedBidId = null;
          document.getElementById('edit-bid-btn').disabled = true;
          document.getElementById('delete-bid-btn').disabled = true;
        }
        // Reload all bids and stats to reflect the change
        await loadBids();
        loadStats();
      });

      socket.on('bidders_count_update', loadStats);

      socket.on('auction_paused', () => {
        // Store the time remaining when paused
        if(auctionEnd){
          pausedTimeRemaining = auctionEnd - new Date();
        }
        auctionPaused = true;
        setPauseButtonState(true);
        AuctionGraphs.stopXAxisExpansion();
      });

      socket.on('auction_resumed', () => {
        // Recalculate auction end time based on stored remaining time
        if(pausedTimeRemaining !== null){
          auctionEnd = new Date(new Date().getTime() + pausedTimeRemaining);
          pausedTimeRemaining = null;
        }
        auctionPaused = false;
        setPauseButtonState(false);
        AuctionGraphs.startXAxisExpansion(auctionStart);
        updateChartAndTable();
      });

      socket.on('connect_error', (err) => {
        console.error('Socket connect_error:', err?.message || err);
      });
    }

    // --- Pause/Resume toggle ---
    async function togglePauseResume(){
      if(!auctionLive) return;
      try {
        const isPause = !auctionPaused; // If currently not paused, we're pausing
        const res = await authFetch(`/events/${eventId}/${isPause ? 'pause' : 'resume'}`, { method:'PATCH' });
        if(res.ok){
          if(isPause){
            auctionPaused = true;
            setPauseButtonState(true);
            // Store time remaining when pausing
            if(auctionEnd){
              pausedTimeRemaining = auctionEnd - new Date();
            }
          } else {
            // Recalculate end time when resuming
            if(pausedTimeRemaining !== null){
              auctionEnd = new Date(new Date().getTime() + pausedTimeRemaining);
              pausedTimeRemaining = null;
            }
            auctionPaused = false;
            setPauseButtonState(false);
            updateChartAndTable();
          }
        }
      } catch(e) {
        console.error(e);
      }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      eventId = params.get('event_id');
      if(!eventId){
        alert('Missing event_id');
        window.location.href = 'events.html';
        return;
      }

      // Tab navigation
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          if (tabName === "pricing") {
            // Already on pricing page, do nothing
            return;
          }
          if (tabName === "docs") {
            // Navigate to docs.html
            window.location.href = `docs.html?event_id=${eventId}`;
            return;
          }
          if (tabName === "responses") {
            // Navigate to response.html
            window.location.href = `response.html?eventId=${eventId}`;
            return;
          }
          // Navigate to event.html with the selected tab
          window.location.href = `event.html?id=${eventId}&tab=${tabName}`;
        });
      });

      pauseResumeBtn.addEventListener('click', togglePauseResume);
      
      // DEBUG: Start auction now button
      const debugStartNowBtn = document.getElementById('debug-start-now-btn');
      if (debugStartNowBtn) {
        debugStartNowBtn.addEventListener('click', async () => {
          if (!confirm('DEBUG: Start this auction immediately?')) return;
          
          try {
            const now = new Date();
            const res = await authFetch(`/events/${eventId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ...eventData,
                auction_time: now.toISOString()
              })
            });
            
            if (res.ok) {
              console.log('Auction start time set to NOW! Refreshing...');
              window.location.reload();
            } else {
              const error = await res.json();
              console.error('Failed to start auction:', error.error || 'Unknown error');
            }
          } catch (e) {
            console.error('Error starting auction:', e);
          }
        });
      }
      
      // Attach Edit/Delete button handlers
      const editBtn = document.getElementById('edit-bid-btn');
      const deleteBtn = document.getElementById('delete-bid-btn');
      
      if (editBtn && deleteBtn) {
        console.log('Edit/Delete buttons found and attaching listeners');
        editBtn.addEventListener('click', editSelectedBid);
        deleteBtn.addEventListener('click', deleteSelectedBid);
      } else {
        console.error('Edit/Delete buttons not found!');
      }

      await loadEvent();
      await loadStats();
      await loadBids();

      // Ensure chart initializes correctly on first page load with proper baseline
      const totalBaseline = Array.from(baselineMap.values()).reduce((acc, li) => acc + (li.ext_baseline || 0), 0);
      lastTotalBaseline = totalBaseline;
      console.log('Initial chart baseline setup:', totalBaseline);
      AuctionGraphs.initChart('bid-chart', totalBaseline, currencySymbol);
      AuctionGraphs.showSavingsByBidder(biddersMap, currencySymbol, totalBaseline);
      connectSocket();

      // Countdown timer updates every second
      countdownInterval = setInterval(() => {
        updateCountdown();
      }, 1000);
      updateCountdown();
      
      // If auction is already live when page loads, start x-axis tracking
      if (auctionLive && !auctionPaused && auctionStart) {
        console.log('Auction already live on page load, starting x-axis tracking');
        AuctionGraphs.startXAxisExpansion(auctionStart);
      }
    });
  </script>
</body>
</html>